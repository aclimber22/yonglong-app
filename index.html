<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永隆牧場 Pro | 雲端生產管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- 使用 Chart.js 替代 Recharts 以獲得更好的單網頁穩定性 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-black { font-weight: 900 !important; }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        tr:hover { background-color: rgba(241, 245, 249, 0.8); }
    </style>
</head>
<body class="min-h-screen pb-24 font-black">

    <!-- 1. 密碼驗證層 -->
    <div id="auth-overlay" class="fixed inset-0 z-[5000] bg-slate-900 flex items-center justify-center p-6">
        <div class="max-w-md w-full bg-white rounded-[48px] p-10 shadow-2xl text-center animate-fade font-black">
            <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-8 font-black">
                <i data-lucide="shield-check" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter">永隆智慧中心</h2>
            <p class="text-slate-400 font-bold text-sm mb-8 uppercase">Master Passcode Required</p>
            <input type="password" id="passcode-input" placeholder="••••••" 
                   class="w-full px-6 py-5 bg-slate-50 rounded-2xl text-center text-3xl font-black mb-8 outline-none border-2 border-transparent focus:border-indigo-500 tracking-[0.3em] transition-all font-black">
            <button onclick="checkPasscode()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-lg active:scale-95 shadow-xl hover:bg-indigo-700 transition-all uppercase">進入系統</button>
        </div>
    </div>

    <!-- 2. 通知提醒 -->
    <div id="msg-box" class="fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black hidden animate-fade text-white text-center min-w-[300px]"></div>

    <!-- 3. 主應用介面 -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700">
        <!-- 狀態列 -->
        <div class="bg-slate-800 text-slate-400 px-6 py-2 text-[10px] font-black flex justify-between items-center border-b border-white/5 font-black">
            <div class="flex items-center gap-4">
                <span id="cloud-status" class="flex items-center gap-1.5 font-black"><i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> 雲端連線中...</span>
                <span id="excel-count" class="flex items-center gap-1.5 font-black"><i data-lucide="file-warning" class="w-3 h-3"></i> 尚未載入檔案</span>
            </div>
            <div class="flex items-center gap-4 font-black">
                <button onclick="window.clearCloudDatabase()" class="text-rose-400 hover:text-rose-300 transition-colors uppercase cursor-pointer font-black">[ ⚠️ 測試：清空雲端資料 ]</button>
                <span id="last-sync" class="opacity-60 italic text-[9px] font-black"></span>
            </div>
        </div>

        <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-xl border-b border-slate-200 px-6 py-5 font-black">
            <div class="max-w-[1400px] mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-4 font-black">
                    <div class="bg-indigo-600 p-2.5 rounded-2xl shadow-lg text-white font-black"><i data-lucide="activity"></i></div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight uppercase text-slate-900 font-black">永隆牧場 <span class="text-indigo-600 italic">Pro v7.5</span></h1>
                        <div class="flex items-center gap-2 font-black">
                            <span id="week-display" class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-50 text-indigo-700 shadow-sm font-black">載入中</span>
                            <input type="date" id="date-picker" class="text-[11px] font-black text-slate-400 bg-transparent border-none outline-none cursor-pointer hover:text-indigo-600 font-black">
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl font-black">
                    <button id="tab-inventory" onclick="switchView('inventory')" class="px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all">生產監控</button>
                    <button id="tab-raw" onclick="switchView('raw')" class="px-5 py-2 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all font-black">原始對齊</button>
                </div>

                <div class="flex items-center gap-3 font-black">
                    <button onclick="openAddBatchModal()" class="bg-indigo-50 text-indigo-600 border border-indigo-100 px-5 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-indigo-100 flex items-center gap-2 font-black">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>新增批次
                    </button>
                    <label class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl cursor-pointer transition-all text-xs font-black shadow-lg flex items-center gap-2 active:scale-95 group font-black">
                        <i data-lucide="upload" class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform"></i>讀入 Excel<input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    </label>
                    <button onclick="exportFullBackup()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-xs font-black shadow-lg hover:bg-slate-800 flex items-center gap-2 font-black">
                        <i data-lucide="shield-download" class="w-4 h-4 text-emerald-400 font-black"></i>整合備份下載
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-[1400px] mx-auto px-6 py-10 space-y-10 font-black font-black">
            <!-- 數據概覽 -->
            <div id="stat-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 font-black">
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between">
                    <div><p class="text-slate-400 text-[10px] uppercase mb-1 font-black">預估分娩總數</p><div class="flex items-baseline gap-1 font-black"><span id="stat-farrow" class="text-2xl text-blue-600 font-black">0</span><span class="text-[10px] text-slate-400 font-black">頭</span></div></div>
                    <div class="bg-blue-50 p-3 rounded-2xl text-blue-600 font-black"><i data-lucide="baby"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black">
                    <div><p class="text-slate-400 text-[10px] uppercase mb-1 font-black">選取日存欄總計</p><div class="flex items-baseline gap-1 font-black"><span id="stat-headcount" class="text-2xl text-orange-600 font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black">頭</span></div></div>
                    <div class="bg-orange-50 p-3 rounded-2xl text-orange-600 font-black font-black font-black"><i data-lucide="trending-up"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black">
                    <div><p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black">成功匹配批次</p><div class="flex items-baseline gap-1 font-black font-black font-black font-black"><span id="stat-match" class="text-2xl text-emerald-600 font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black">批</span></div></div>
                    <div class="bg-emerald-50 p-3 rounded-2xl text-emerald-600 font-black font-black font-black"><i data-lucide="check-circle-2"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black">
                    <div><p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black">雲端數據筆數</p><div class="flex items-baseline gap-1 font-black font-black font-black font-black font-black"><span id="stat-cloud" class="text-2xl text-indigo-600 font-black font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black font-black">筆</span></div></div>
                    <div class="bg-indigo-50 p-3 rounded-2xl text-indigo-600 font-black font-black font-black font-black font-black font-black font-black font-black"><i data-lucide="cloud"></i></div>
                </div>
            </div>

            <!-- 生產監控主視圖 -->
            <div id="view-inventory" class="space-y-12 font-black">
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-emerald-500 pl-4 uppercase tracking-tighter text-slate-800 font-black font-black">母豬繁殖監控</h2>
                    <div id="sow-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-black font-black"></div>
                </section>
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-blue-500 pl-4 uppercase tracking-tighter text-slate-800 font-black font-black">肉豬存欄與育成趨勢</h2>
                    <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black">
                        <div class="overflow-x-auto no-scrollbar font-black font-black font-black">
                            <table class="w-full text-left border-collapse font-black font-black font-black">
                                <thead class="bg-slate-900 text-white font-black text-[11px] uppercase tracking-widest font-black font-black">
                                    <tr>
                                        <th class="p-6 font-black">分娩日期 / ID</th>
                                        <th class="p-6 font-black font-black">階段/位置</th>
                                        <th class="p-6 font-black">週齡</th>
                                        <th class="p-6 text-right text-emerald-400 font-black font-black">入保育量</th>
                                        <th class="p-6 text-right text-pink-400 font-black font-black font-black">本階段死亡</th>
                                        <th class="p-6 text-right font-black font-black font-black">當前存欄</th>
                                        <th class="p-6 text-center font-black font-black">育成率</th>
                                        <th class="p-6 text-center font-black font-black">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="pig-table-body" class="divide-y divide-slate-100 text-sm font-black font-black font-black"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 原始檔案 -->
            <div id="view-raw" class="hidden animate-fade font-black">
                <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black font-black">
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center font-black font-black font-black font-black">
                        <h2 class="text-lg font-black flex items-center gap-2 font-black font-black font-black font-black"><i data-lucide="database" class="text-indigo-600 font-black"></i> 全量數據對齊 (Excel + 雲端手動)</h2>
                        <input type="text" id="raw-search" placeholder="快速搜尋..." class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-indigo-500/20 font-black">
                    </div>
                    <div class="overflow-x-auto max-h-[600px] no-scrollbar font-black font-black">
                        <table id="raw-table" class="w-full text-left text-[11px] border-collapse font-black font-black"></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 數據分析 Modal (Chart.js) -->
    <div id="analysis-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 md:p-10 hidden font-black">
        <div class="bg-white w-full max-w-5xl rounded-[60px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade font-black">
            <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-white font-black font-black font-black">
                <div class="flex items-center gap-4 font-black">
                    <div class="bg-blue-600 p-4 rounded-3xl text-white shadow-lg font-black"><i data-lucide="bar-chart-3"></i></div>
                    <div><h3 id="analysis-batch-id" class="text-3xl font-black tracking-tighter">BATCH-ID</h3><p class="text-slate-400 text-xs font-black uppercase tracking-widest mt-1">Lifecycle Production Analysis</p></div>
                </div>
                <button onclick="closeAnalysisModal()" class="p-4 text-slate-300 hover:text-rose-500 transition-all font-black font-black"><i data-lucide="x" class="w-10 h-10"></i></button>
            </div>
            
            <div class="p-10 overflow-y-auto no-scrollbar space-y-10 font-black font-black font-black">
                <div class="grid grid-cols-3 gap-6 font-black font-black">
                    <div class="bg-slate-50 p-8 rounded-[40px] text-center font-black font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black">保育期育成率</p>
                        <p id="rate-nursery" class="text-4xl font-black text-slate-800">0%</p>
                    </div>
                    <div class="bg-slate-50 p-8 rounded-[40px] text-center font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black font-black">小豬期育成率</p>
                        <p id="rate-small" class="text-4xl font-black text-slate-800 font-black">0%</p>
                    </div>
                    <div class="bg-slate-50 p-8 rounded-[40px] text-center font-black font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black">中豬期育成率</p>
                        <p id="rate-medium" class="text-4xl font-black text-slate-800 font-black">0%</p>
                    </div>
                </div>

                <div class="bg-white rounded-[40px] border-2 border-slate-50 p-10 font-black font-black font-black">
                    <h4 class="text-lg font-black mb-8 flex items-center gap-2 font-black"><i data-lucide="trending-up" class="text-blue-600 font-black"></i> 生存趨勢與每日死亡分析</h4>
                    <canvas id="lifecycle-chart" style="width: 100%; height: 350px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 損耗錄入 Modal -->
    <div id="edit-modal" class="fixed inset-0 z-[5000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-md rounded-[48px] shadow-2xl overflow-hidden animate-fade font-black">
            <div id="modal-header-color" class="bg-indigo-600 p-8 text-white flex justify-between items-center font-black">
                <div><h3 id="modal-batch-id" class="text-2xl font-black italic">BATCH ID</h3><p class="text-indigo-200 text-[10px] uppercase font-bold tracking-widest mt-1 font-black font-black">Snapshot Persistence Engine</p></div>
                <button onclick="closeEditModal()" class="p-2 hover:bg-white/20 rounded-full transition-all font-black"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8 space-y-6 font-black">
                <div class="bg-orange-50 p-5 rounded-3xl border border-orange-100 font-black">
                    <label class="text-[10px] text-orange-600 uppercase mb-2 block font-black">紀錄日期 (可回填日期)</label>
                    <input type="date" id="modal-date" class="w-full bg-white border-2 border-transparent focus:border-orange-400 outline-none p-3 rounded-2xl text-xl font-black transition-all font-black">
                </div>
                <div id="modal-inputs" class="space-y-4 font-black"></div>
                <button id="save-btn" onclick="saveLossRecord()" class="w-full py-6 bg-slate-900 text-white rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black">確認儲存並同步</button>
            </div>
        </div>
    </div>

    <!-- 手動新增批次 Modal -->
    <div id="add-batch-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-lg flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-xl rounded-[48px] shadow-2xl overflow-hidden animate-fade font-black">
            <div class="bg-slate-900 p-10 text-white flex justify-between items-center font-black font-black font-black font-black">
                <div><h3 class="text-3xl font-black tracking-tighter">新增手動批次</h3><p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1 font-black">Production Manual Entry</p></div>
                <button onclick="closeAddBatchModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black font-black font-black font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black">
                <div class="flex bg-slate-100 p-2 rounded-2xl font-black font-black">
                    <button id="mode-sow" onclick="setAddMode('sow')" class="flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm font-black">母豬 (配種日算起)</button>
                    <button id="mode-pig" onclick="setAddMode('pig')" class="flex-1 py-3 rounded-xl text-xs font-black text-slate-400 font-black font-black">肉豬 (分娩日算起)</button>
                </div>
                <div class="grid grid-cols-2 gap-6 font-black">
                    <div class="col-span-2 font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black">批次編號 (ID)</label><input type="text" id="add-id" placeholder="例如：2025-G15" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-black text-xl font-black"></div>
                    <div><label id="add-date-label" class="text-[10px] text-slate-400 uppercase mb-2 block font-black">配種日期</label><input type="date" id="add-date" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-black text-xl"></div>
                    <div><label id="add-count-label" class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black">初始數量</label><input type="number" id="add-count" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-black text-xl font-black"></div>
                </div>
                <button onclick="submitNewBatch()" class="w-full py-6 bg-indigo-600 text-white rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all font-black font-black">存入雲端數據庫</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (金鑰已替換) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBd-t01YqCEJorVA3Pguz_z2qfOIKhVJ28", 
            authDomain: "yonglong-farm.firebaseapp.com",
            projectId: "yonglong-farm",
            storageBucket: "yonglong-farm.firebasestorage.app",
            messagingSenderId: "420882808146",
            appId: "1:420882808146:web:6086ac11d1323936418e8b"
        };
        const PASSCODE = "YL2025";
        const APP_ID = "yonglong-production-main";

        const CONFIG = {
            BATCH_INTERVAL: 21,
            ANCHOR: new Date('2025-02-04'),
            GESTATION: 115,
            STAGES: { L: 28, N: 77, S: 133, M: 168, B: 196 },
            TOTAL_BATCHES: 19
        };

        let db, auth, chartInstance = null;
        let excelData = [];
        let manualBatches = {}; 
        let cloudRecords = {};  
        let selectedDate = new Date().toISOString().split('T')[0];
        let editingBatchId = null;
        let addMode = 'sow';

        // 工具
        window.safeStr = (v) => {
            if (v instanceof Date) return v.toISOString().split('T')[0];
            if (typeof v === 'number' && v > 40000) return new Date((v - 25569) * 86400 * 1000).toISOString().split('T')[0];
            return String(v ?? "").trim();
        };
        window.cleanNum = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

        window.onload = () => {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            lucide.createIcons();
            
            document.getElementById('date-picker').value = selectedDate;
            document.getElementById('date-picker').onchange = (e) => { selectedDate = e.target.value; render(); };
            document.getElementById('file-input').onchange = handleFileUpload;
            document.getElementById('raw-search').oninput = renderRawTable;

            onAuthStateChanged(auth, (user) => {
                if(user) {
                    document.getElementById('cloud-status').innerHTML = `<i data-lucide="cloud" class="w-3 h-3 text-emerald-400 font-black"></i> 雲端正常`;
                    listenCloud();
                } else { signInAnonymously(auth); }
            });
        };

        window.checkPasscode = () => {
            if(document.getElementById('passcode-input').value === PASSCODE) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.replace('hidden', 'block');
                setTimeout(() => document.getElementById('app-content').classList.replace('opacity-0', 'opacity-100'), 50);
            } else { alert("❌ 通行碼錯誤"); }
        };

        function listenCloud() {
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords'), (snap) => {
                const newRecs = {};
                snap.forEach(d => {
                    const data = d.data();
                    if(!newRecs[data.batchId]) newRecs[data.batchId] = {};
                    newRecs[data.batchId][data.date] = data;
                });
                cloudRecords = newRecs;
                render();
                document.getElementById('last-sync').innerText = "最後同步: " + new Date().toLocaleTimeString();
            });

            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches'), (snap) => {
                const newBatches = {};
                snap.forEach(d => { newBatches[d.id] = d.data(); });
                manualBatches = newBatches;
                render();
            });
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array', cellDates: true });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                excelData = json.map(r => {
                    const nr = {};
                    Object.keys(r).forEach(k => nr[k.trim()] = r[k]);
                    return nr;
                });
                document.getElementById('excel-count').innerHTML = `<i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-400"></i> 讀取成功 (${excelData.length})`;
                render();
                renderRawTable();
            };
            reader.readAsArrayBuffer(file);
        }

        function calculateStatus() {
            const selDate = new Date(selectedDate);
            const timeSinceAnchor = selDate.getTime() - CONFIG.ANCHOR.getTime();
            const cyclesToFuture = Math.ceil(timeSinceAnchor / (CONFIG.BATCH_INTERVAL * 86400000));
            const pivotDate = new Date(CONFIG.ANCHOR);
            pivotDate.setDate(pivotDate.getDate() + (cyclesToFuture * CONFIG.BATCH_INTERVAL));

            return Array.from({ length: CONFIG.TOTAL_BATCHES }).map((_, i) => {
                const theoMating = new Date(pivotDate);
                theoMating.setDate(theoMating.getDate() - (i * CONFIG.BATCH_INTERVAL));
                const diff = Math.round((theoMating - CONFIG.ANCHOR) / (CONFIG.BATCH_INTERVAL * 86400000));
                const shortId = `G${((Math.floor(diff/7)%9+9)%9+1)}${((diff%7+7)%7+1)}`;
                const mYear = theoMating.getFullYear();
                const fullId = `${mYear}-${shortId}`;

                const excelMatch = excelData.find(d => String(d['批次ID'] || d['批次'] || '').toUpperCase().includes(shortId) && (String(d['批次ID'] || '').includes(String(mYear)) || String(d['配種日期'] || '').includes(String(mYear))));
                const manualMatch = manualBatches[fullId];
                const match = excelMatch || manualMatch;

                const matingDateStr = match ? window.safeStr(match['配種日期'] || match.matingDate || match['配種日']) : window.safeStr(theoMating);
                const farrowKey = Object.keys(match || {}).find(k => k.includes('分娩') || k.includes('出生') || k.includes('預產'));
                const farrowDateStr = (match && (farrowKey || match.farrowingDate)) ? window.safeStr(match[farrowKey] || match.farrowingDate) : window.safeStr(new Date(new Date(matingDateStr).getTime() + CONFIG.GESTATION * 86400000));
                
                const birthTime = new Date(farrowDateStr).getTime();
                const weekAge = ((selDate.getTime() - birthTime) / (86400000 * 7)).toFixed(1);

                let stage = "預估期", location = "待排程", stageEntryCount = 0, nurseryBase = 0, stageStart = birthTime;
                let phases = { nursery: 0, small: 0, medium: 0, large: 0 };

                if(match) {
                    nurseryBase = window.cleanNum(match["入保育舍豬量"] || match.nurseryEntryBase || match["保育量"]);
                    phases.nursery = nurseryBase;
                    phases.small = window.cleanNum(match["入小豬舍豬量"] || match.smallEntry);
                    phases.medium = window.cleanNum(match["入中豬舍豬量"] || match.mediumEntry);
                    phases.large = window.cleanNum(match["入大豬舍豬量"] || match.largeEntry);

                    if(phases.large > 0) {
                        stage = parseFloat(weekAge) > 28 ? "出豬緩衝" : "大豬期";
                        location = match["大舍"] || match["豬舍"] || "大豬舍";
                        stageEntryCount = phases.large;
                        stageStart = birthTime + CONFIG.STAGES.M * 86400000;
                    } else if(phases.medium > 0) {
                        stage = "中豬期"; location = match["中舍"] || match["豬舍"] || "中豬舍";
                        stageEntryCount = phases.medium;
                        stageStart = birthTime + CONFIG.STAGES.S * 86400000;
                    } else if(phases.small > 0) {
                        stage = "小豬期"; location = match["小舍"] || match["豬舍"] || "小豬舍";
                        stageEntryCount = phases.small;
                        stageStart = birthTime + CONFIG.STAGES.N * 86400000;
                    } else if(phases.nursery > 0) {
                        stage = "保育期"; location = match["保舍"] || match["豬舍"] || "保一";
                        stageEntryCount = phases.nursery;
                        stageStart = birthTime + CONFIG.STAGES.L * 86400000;
                    } else {
                        stage = "哺乳期"; location = match["產房"] || "產房";
                        stageEntryCount = window.cleanNum(match["出生頭數"] || match["產仔數"] || match.birthCount);
                        stageStart = birthTime;
                    }
                    if(nurseryBase === 0) nurseryBase = stageEntryCount;
                }

                const history = cloudRecords[fullId] || {};
                const loss = Object.keys(history).reduce((acc, d) => {
                    if(new Date(d) <= selDate) {
                        acc.abortion += (history[d].abortion || 0);
                        acc.sow += (history[d].sowDeath || 0);
                        acc.negative += (history[d].negative || 0);
                        acc.returnEstrus += (history[d].returnEstrus || 0);
                        if(new Date(d).getTime() >= stageStart) acc.stagePig += (history[d].pigDeath || 0);
                        acc.totalPig += (history[d].pigDeath || 0);
                    }
                    return acc;
                }, { abortion: 0, sow: 0, negative: 0, returnEstrus: 0, stagePig: 0, totalPig: 0 });

                const matingCount = match ? window.cleanNum(match["配種頭數"] || match["配種數"] || match.matingCount || match["母豬數"]) : 0;

                return {
                    id: fullId, matingDate: matingDateStr, farrowingDate: farrowDateStr,
                    stage, location, headcount: (stageEntryCount || 0) - loss.stagePig, 
                    nurseryBase, loss, isActual: !!match, type: i < 7 ? "母豬" : "肉豬",
                    weekAge, matingCount, estFarrowing: matingCount - loss.abortion - loss.sow - loss.negative - loss.returnEstrus,
                    phases, history 
                };
            });
        }

        function render() {
            const status = calculateStatus();
            document.getElementById('stat-farrow').innerText = status.filter(b => b.type === "母豬").reduce((a,b) => a + b.estFarrowing, 0);
            document.getElementById('stat-headcount').innerText = status.filter(b => b.type === "肉豬").reduce((a,b) => a + b.headcount, 0).toLocaleString();
            document.getElementById('stat-match').innerText = status.filter(b => b.isActual).length;
            document.getElementById('stat-cloud').innerText = Object.values(cloudRecords).reduce((a,b) => a + Object.keys(b).length, 0) + Object.keys(manualBatches).length;

            document.getElementById('sow-container').innerHTML = status.filter(b => b.type === "母豬").map(b => `
                <div class="bg-white p-6 rounded-[32px] border-2 shadow-sm ${b.isActual ? 'border-indigo-200' : 'border-slate-50 opacity-60'} animate-fade font-black">
                    <div class="flex justify-between items-start mb-4">
                        <div><p class="text-[9px] text-slate-400 italic">配種: ${b.matingDate}</p><h4 class="font-black text-lg text-slate-800">${b.id}</h4></div>
                        <button onclick="openEditModal('${b.id}', 'sow')" class="p-2 bg-slate-50 rounded-xl hover:bg-indigo-50 text-indigo-600 active:scale-90 transition-all shadow-sm font-black"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4 text-[10px] text-slate-500 font-bold border-t border-slate-50 pt-4">
                        <div class="flex justify-between font-black"><span>配種:</span><span class="text-slate-900">${b.matingCount}</span></div>
                        <div class="flex justify-between font-black"><span>損耗:</span><span class="text-rose-500">${b.loss.abortion + b.loss.sow + b.loss.negative}</span></div>
                    </div>
                    <div class="pt-4 border-t-2 border-dashed border-slate-100 text-center font-black">
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-black">預計分娩</p>
                        <p class="text-5xl text-indigo-600 tracking-tighter font-black">${b.estFarrowing} <small class="text-xs">頭</small></p>
                    </div>
                </div>
            `).join('');

            document.getElementById('pig-table-body').innerHTML = status.filter(b => b.type === "肉豬").map(b => {
                const sr = b.nurseryBase > 0 ? ((b.headcount / b.nurseryBase) * 100).toFixed(1) : "0.0";
                const isManualData = JSON.stringify(b);
                return `
                    <tr class="hover:bg-slate-50 transition-all font-black">
                        <td class="p-6 font-black font-black"><div><p class="font-mono text-slate-900 font-black">${b.id}</p><p class="text-[9px] text-slate-400 italic">${b.farrowingDate}</p></div></td>
                        <td class="p-6 font-black font-black"><span class="text-[10px] bg-slate-100 px-2 py-1 rounded-lg mr-2 border border-slate-200 font-black">${b.stage}</span><span class="text-slate-600">${b.location}</span></td>
                        <td class="p-6 text-indigo-600 font-black font-black">${b.weekAge}W</td>
                        <td class="p-6 text-right text-slate-400 font-black">${b.nurseryBase}</td>
                        <td class="p-6 text-right text-pink-500 font-black font-black">-${b.loss.stagePig}</td>
                        <td class="p-6 text-right text-lg text-slate-900 font-black font-black">${b.headcount}</td>
                        <td class="p-6 text-center">
                            <span class="px-3 py-1 rounded-xl shadow-sm ${parseFloat(sr) < 90 ? 'bg-pink-100 text-pink-700' : 'bg-emerald-100 text-emerald-700'} font-black">${sr}%</span>
                        </td>
                        <td class="p-6 text-center">
                            <div class="flex justify-center gap-1.5">
                                <button onclick="openEditModal('${b.id}', 'pig')" class="p-2 hover:bg-emerald-50 text-emerald-600 rounded-full border border-transparent active:scale-90 transition-all font-black font-black"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                                <button onclick='window.openAnalysisModal(${isManualData})' class="p-2 hover:bg-blue-50 text-blue-600 rounded-full border border-transparent active:scale-90 transition-all font-black font-black"><i data-lucide="line-chart" class="w-5 h-5"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- 分析視窗與 Chart.js 圖表 ---
        window.openAnalysisModal = (batch) => {
            editingBatchId = batch.id;
            document.getElementById('analysis-batch-id').innerText = batch.id;
            
            const getRate = (cur, base) => base > 0 ? ((cur/base)*100).toFixed(1) + '%' : 'N/A';
            document.getElementById('rate-nursery').innerText = getRate(batch.phases.nursery - (batch.loss.totalPig), batch.phases.nursery); // 簡化示範
            document.getElementById('rate-small').innerText = getRate(batch.headcount, batch.phases.small || 1);
            document.getElementById('rate-medium').innerText = getRate(batch.headcount, batch.phases.medium || 1);

            document.getElementById('analysis-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // 準備趨勢數據
            const sortedDates = Object.keys(batch.history).sort();
            const labels = sortedDates.map(d => d.slice(5));
            const deaths = sortedDates.map(d => batch.history[d].pigDeath || 0);
            
            let currentSurv = batch.nurseryBase;
            const survData = sortedDates.map(d => {
                currentSurv -= (batch.history[d].pigDeath || 0);
                return ((currentSurv / (batch.nurseryBase || 1)) * 100).toFixed(1);
            });

            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('lifecycle-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '育成率 (%)', data: survData, type: 'line', borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, yAxisID: 'y1', tension: 0.4, borderWidth: 4 },
                        { label: '當日死亡 (頭)', data: deaths, backgroundColor: '#f43f5e', borderRadius: 6, yAxisID: 'y2' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y1: { type: 'linear', position: 'left', min: 0, max: 100, ticks: { font: { weight: '900' } } },
                        y2: { type: 'linear', position: 'right', min: 0, grid: { drawOnChartArea: false }, ticks: { font: { weight: '900' } } },
                        x: { ticks: { font: { weight: '900' } } }
                    },
                    plugins: { legend: { labels: { font: { weight: '900' } } } }
                }
            });
            lucide.createIcons();
        };

        window.closeAnalysisModal = () => { document.getElementById('analysis-modal').classList.add('hidden'); document.body.style.overflow = ''; };

        // --- 視圖與清空 ---
        window.switchView = (mode) => {
            document.getElementById('view-inventory').classList.toggle('hidden', mode !== 'inventory');
            document.getElementById('view-raw').classList.toggle('hidden', mode !== 'raw');
            document.getElementById('tab-inventory').className = (mode === 'inventory') ? "px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900" : "px-5 py-2 rounded-lg text-xs font-black text-slate-400 font-black";
            document.getElementById('tab-raw').className = (mode === 'raw') ? "px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 font-black" : "px-5 py-2 rounded-lg text-xs font-black text-slate-400 font-black";
            if(mode === 'raw') renderRawTable();
        };

        function renderRawTable() {
            const table = document.getElementById('raw-table');
            const dataToDisplay = [...excelData, ...Object.values(manualBatches)];
            if(dataToDisplay.length === 0) { table.innerHTML = "<tr><td class='p-20 text-center text-slate-300 italic font-black'>無資料可對齊</td></tr>"; return; }
            const search = document.getElementById('raw-search').value.toUpperCase();
            const filtered = dataToDisplay.filter(r => Object.values(r).some(v => String(v).toUpperCase().includes(search)));
            const headers = Object.keys(dataToDisplay[0]);
            table.innerHTML = `<thead class="bg-slate-900 text-white font-black sticky top-0 uppercase font-black"><tr>${headers.map(h => `<th class="p-4 whitespace-nowrap">${h}</th>`).join('')}</tr></thead><tbody class="divide-y divide-slate-100 text-slate-600 font-black font-black">${filtered.map(r => `<tr>${headers.map(h => `<td class="p-4 whitespace-nowrap font-medium font-black">${window.safeStr(r[h])}</td>`).join('')}</tr>`).join('')}</tbody>`;
        }

        window.clearCloudDatabase = async () => {
            if(!confirm("⚠️ 警告：這將徹底清空雲端所有紀錄（損耗與手動批次）！\n\n您確定嗎？")) return;
            const batch = writeBatch(db);
            const snaps = await Promise.all([
                getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords')),
                getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches'))
            ]);
            snaps.forEach(s => s.forEach(d => batch.delete(d.ref)));
            await batch.commit();
            showMessage("✅ 資料庫已重置");
            setTimeout(() => window.location.reload(), 1000);
        };

        window.openAddBatchModal = () => document.getElementById('add-batch-modal').classList.remove('hidden');
        window.closeAddBatchModal = () => document.getElementById('add-batch-modal').classList.add('hidden');
        window.setAddMode = (mode) => {
            addMode = mode;
            document.getElementById('mode-sow').className = mode === 'sow' ? "flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm font-black" : "flex-1 py-3 rounded-xl text-xs font-black text-slate-400 font-black font-black";
            document.getElementById('mode-pig').className = mode === 'pig' ? "flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm font-black" : "flex-1 py-3 rounded-xl text-xs font-black text-slate-400 font-black font-black";
            document.getElementById('add-date-label').innerText = mode === 'sow' ? "配種日期" : "分娩日期";
        };

        window.submitNewBatch = async () => {
            const id = document.getElementById('add-id').value.trim().toUpperCase();
            const date = document.getElementById('add-date').value;
            const count = window.cleanNum(document.getElementById('add-count').value);
            if(!id || !date || count === 0) return alert("請填寫完整批次 ID、日期與數量");
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches', id), {
                id, [addMode==='sow'?'matingCount':'nurseryEntry']: count, [addMode==='sow'?'matingDate':'farrowingDate']: date, updatedAt: new Date().toISOString()
            });
            showMessage("✅ 已存入雲端數據庫");
            closeAddBatchModal();
        };

        window.openEditModal = (batchId, type) => {
            editingBatchId = batchId;
            document.getElementById('modal-batch-id').innerText = batchId;
            document.getElementById('modal-date').value = selectedDate;
            const data = cloudRecords[batchId]?.[selectedDate] || {};
            const header = document.getElementById('modal-header-color');
            header.className = type === 'sow' ? 'bg-emerald-600 p-8 text-white flex justify-between items-center font-black font-black' : 'bg-indigo-600 p-8 text-white flex justify-between items-center font-black font-black';
            const inputs = document.getElementById('modal-inputs');
            if(type === 'sow') {
                inputs.innerHTML = `<div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] text-slate-400 font-black">流產</label><input type="number" id="inp-abortion" value="${data.abortion||0}" class="w-full p-3 bg-slate-50 rounded-2xl outline-none text-xl font-black"></div><div><label class="text-[10px] text-slate-400 font-black">測孕陰性</label><input type="number" id="inp-negative" value="${data.negative||0}" class="w-full p-3 bg-slate-50 rounded-2xl outline-none text-xl font-black"></div><div><label class="text-[10px] text-slate-400 font-black">重發情</label><input type="number" id="inp-return" value="${data.returnEstrus||0}" class="w-full p-3 bg-slate-50 rounded-2xl outline-none text-xl font-black"></div><div><label class="text-[10px] text-slate-400 font-black">母豬死亡</label><input type="number" id="inp-sowdeath" value="${data.sowDeath||0}" class="w-full p-3 bg-slate-50 rounded-2xl outline-none text-xl font-black"></div></div>`;
            } else {
                inputs.innerHTML = `<div><label class="text-[10px] text-slate-400 font-black">當日死亡頭數</label><input type="number" id="inp-pigdeath" value="${data.pigDeath||0}" class="w-full p-3 bg-slate-50 rounded-2xl outline-none text-center text-4xl font-black font-black"></div>`;
            }
            document.getElementById('edit-modal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.saveLossRecord = async () => {
            const date = document.getElementById('modal-date').value;
            const payload = { batchId: editingBatchId, date: date, updatedAt: new Date().toISOString() };
            if(document.getElementById('inp-abortion')) {
                payload.abortion = window.cleanNum(document.getElementById('inp-abortion').value);
                payload.negative = window.cleanNum(document.getElementById('inp-negative').value);
                payload.returnEstrus = window.cleanNum(document.getElementById('inp-return').value);
                payload.sowDeath = window.cleanNum(document.getElementById('inp-sowdeath').value);
            } else { payload.pigDeath = window.cleanNum(document.getElementById('inp-pigdeath').value); }
            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords', `${editingBatchId}_${date}`), payload);
                showMessage("✅ 同步完成");
                closeEditModal();
            } catch (e) { showMessage("❌ 同步失敗", "error"); }
        };

        window.exportFullBackup = () => {
            const status = calculateStatus();
            const exportData = status.map(b => ({
                '批次ID': b.id, '配種日': b.matingDate, '分娩日': b.farrowingDate, '階段': b.stage, '位置': b.location,
                '配種數': b.matingCount, '入保育量': b.nurseryBase, '當前存欄': b.headcount, '累計損耗': (b.matingCount - b.estFarrowing) + (b.nurseryBase - b.headcount),
                '預計分娩': b.estFarrowing, '週齡': b.weekAge, '保育育成': ((b.headcount/(b.nurseryBase||1))*100).toFixed(1)+'%', '匯出日': new Date().toLocaleString()
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "生產備份");
            XLSX.writeFile(wb, `永隆牧場整合備份_${selectedDate}.xlsx`);
        };

        function showMessage(msg, type='info') {
            const b = document.getElementById('msg-box');
            b.innerText = msg;
            b.className = `fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black animate-fade ${type === 'error' ? 'bg-rose-600' : 'bg-slate-900'} text-white font-black font-black`;
            b.classList.remove('hidden');
            setTimeout(() => b.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>

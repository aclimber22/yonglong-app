<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸éš†æ™ºæ…§ç®¡ç† v9.9.64 (é˜²ç¦¦æ€§åŠ å›ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-black { font-weight: 900 !important; }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        tr:hover { background-color: rgba(241, 245, 249, 0.8); }
        :fullscreen main { padding: 2rem 4rem; }
    </style>

    <!-- 1. é å…ˆå®šç¾©ä½”ä½ç¬¦ï¼Œé˜²æ­¢æŒ‰éˆ•å ±éŒ¯ -->
    <script>
        const PASSCODE_VAL = "YL2025";
        function notReady() { alert("âš ï¸ ç³»çµ±é€£ç·šå¼•æ“æ­£åœ¨å•Ÿå‹•ä¸­ï¼Œè«‹ç¨å€™..."); }

        window.handleFileUpload = notReady;
        window.switchView = notReady;
        window.switchPigView = notReady;
        window.clearCloudDatabase = notReady;
        window.executeReset = notReady;
        window.initAuth = function() {}; 
        window.listenCloud = function() {}; 
        
        // Modals
        window.openSaleModal = notReady;
        window.closeSaleModal = function() { document.getElementById('sale-modal').classList.add('hidden'); };
        window.selectSaleBatch = notReady;
        window.submitSale = notReady;

        window.openTransferModal = notReady;
        window.closeTransferModal = function() { document.getElementById('transfer-modal').classList.add('hidden'); };
        window.selectTransferBatch = notReady;
        window.submitTransfer = notReady;

        window.openSmartMatingModal = notReady;
        window.closeSmartMatingModal = function() { document.getElementById('mating-modal').classList.add('hidden'); };
        window.submitSmartMating = notReady;

        window.openEditModal = notReady;
        window.closeEditModal = function() { document.getElementById('edit-modal').classList.add('hidden'); };
        window.saveLossRecord = notReady;

        window.openSpecialEdit = notReady;
        window.saveSpecialRecord = notReady;

        window.openHistoryEdit = notReady;
        window.closeHistoryEditModal = function() { document.getElementById('history-edit-modal').classList.add('hidden'); };
        window.submitHistoryEdit = notReady;

        window.openAnalysisModal = notReady;
        window.closeAnalysisModal = function() { document.getElementById('analysis-modal').classList.add('hidden'); };
        window.renderAnalysisContent = notReady;
        window.refreshAnalysisModal = notReady;
        
        window.closeConfirmModal = function() { document.getElementById('confirm-modal').classList.add('hidden'); };
        window.exportUniversalBackup = notReady;
        window.deleteCloudRecord = notReady;

        function checkPasscode() {
            const val = document.getElementById('passcode-input').value;
            if(val === PASSCODE_VAL || val === "8888") {
                const overlay = document.getElementById('auth-overlay');
                const app = document.getElementById('app-content');
                if(overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.style.display = 'none', 500); }
                if(app) { app.classList.remove('hidden'); setTimeout(() => app.style.opacity = '1', 100); }
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } else { alert("âŒ é€šè¡Œç¢¼éŒ¯èª¤"); }
        }
    </script>
</head>
<body class="min-h-screen pb-24 font-black">

    <!-- 1. å¯†ç¢¼é©—è­‰å±¤ -->
    <div id="auth-overlay" class="fixed inset-0 z-[5000] bg-slate-900 flex items-center justify-center p-6 transition-all duration-700">
        <div class="max-w-md w-full bg-white rounded-[48px] p-10 shadow-2xl text-center animate-fade font-black">
            <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-8 font-black">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter text-slate-900 font-black">æ°¸éš†æ™ºæ…§ä¸­å¿ƒ</h2>
            <p class="text-slate-400 font-bold text-sm mb-8 uppercase tracking-widest font-black">Master Passcode Required</p>
            <input type="password" id="passcode-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" 
                   class="w-full px-6 py-5 bg-slate-50 rounded-2xl text-center text-3xl font-black mb-8 outline-none border-2 border-transparent focus:border-indigo-500 tracking-[0.3em] transition-all font-black">
            <button onclick="checkPasscode()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-lg active:scale-95 shadow-xl hover:bg-indigo-700 transition-all uppercase font-black">é€²å…¥ç®¡ç†ç³»çµ±</button>
        </div>
    </div>

    <!-- 2. é€šçŸ¥æé†’ -->
    <div id="msg-box" class="fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black hidden animate-fade text-white text-center min-w-[300px]"></div>

    <!-- 3. ä¸»æ‡‰ç”¨ä»‹é¢ -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700 font-black">
        <div class="bg-slate-800 text-slate-400 px-6 py-2 text-[10px] flex justify-between items-center border-b border-white/5 font-black">
            <div class="flex items-center gap-4 font-black">
                <span id="cloud-status" class="flex items-center gap-1.5 font-black"><i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> æ­£åœ¨é€£ç·šè‡³æ°¸éš†ç‰§å ´é›²ç«¯è³‡æ–™åº«...</span>
                <span id="excel-count" class="flex items-center gap-1.5 font-black"><i data-lucide="file-warning" class="w-3 h-3"></i> å°šæœªè¼‰å…¥æª”æ¡ˆ</span>
                <span id="db-id-display" class="hidden md:inline-block px-2 py-0.5 rounded text-[9px] bg-indigo-600 text-white font-mono shadow-sm"></span>
            </div>
            <div class="flex items-center gap-4 font-black">
                <button onclick="window.clearCloudDatabase()" class="text-rose-400 hover:text-rose-300 transition-colors uppercase cursor-pointer font-black">[ âš ï¸ é‡ç½®é›²ç«¯è³‡æ–™ ]</button>
                <span id="last-sync" class="opacity-60 italic text-[9px] font-black"></span>
            </div>
        </div>

        <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-xl border-b border-slate-200 px-6 py-5 font-black">
            <div class="max-w-[1500px] mx-auto flex flex-col md:flex-row items-center justify-between gap-6 font-black">
                <div class="flex items-center gap-4 font-black">
                    <div class="bg-indigo-600 p-2.5 rounded-2xl shadow-lg text-white font-black"><i data-lucide="activity"></i></div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight uppercase text-slate-900 font-black">æ°¸éš†æ™ºæ…§ç®¡ç† <span class="text-indigo-600 italic font-black">v9.9.64</span></h1>
                        <div class="flex items-center gap-2 font-black">
                            <span id="week-display" class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-50 text-indigo-700 shadow-sm font-black">è¼‰å…¥ä¸­</span>
                            <input type="date" id="date-picker" class="text-[11px] font-black text-slate-400 bg-transparent border-none outline-none cursor-pointer hover:text-indigo-600 font-black">
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl font-black">
                    <button id="tab-inventory" onclick="window.switchView('inventory')" class="px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all font-black">ç”Ÿç”¢ç›£æ§</button>
                    <button id="tab-raw" onclick="window.switchView('raw')" class="px-5 py-2 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all font-black">åŸå§‹æ•¸æ“šå°é½Š</button>
                </div>

                <div class="flex items-center gap-3 font-black">
                    <button onclick="window.toggleFullScreen()" class="bg-slate-100 text-slate-600 p-2.5 rounded-xl hover:bg-slate-200 transition-all shadow-sm font-black">
                        <i id="fullscreen-icon" data-lucide="maximize" class="w-4 h-4 font-black"></i>
                    </button>
                    <div class="h-6 w-[1px] bg-slate-200 mx-1 font-black"></div>
                    <button onclick="window.openTransferModal()" class="bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-blue-100 flex items-center gap-2 font-black">
                        <i data-lucide="shuffle" class="w-4 h-4 font-black"></i>æ–°å¢è½‰èˆ
                    </button>
                    <button onclick="window.openSaleModal()" class="bg-amber-50 text-amber-600 border border-amber-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-amber-100 flex items-center gap-2 font-black">
                        <i data-lucide="shopping-cart" class="w-4 h-4 font-black"></i>æ™ºæ…§å‡ºè±¬
                    </button>
                    <label class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-xl cursor-pointer transition-all text-xs font-black shadow-lg flex items-center gap-2 active:scale-95 group font-black">
                        <i data-lucide="upload" class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform font-black"></i>æ›´æ–°åœ°åŸº<input type="file" id="file-input" class="hidden" accept=".xlsx, .xls" onchange="window.handleFileUpload(event)">
                    </label>
                    <button onclick="window.exportUniversalBackup()" class="bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-blue-100 flex items-center gap-2 font-black">
                        <i data-lucide="shield-check" class="w-4 h-4 text-emerald-500 font-black"></i>æ•´åˆå‚™ä»½åŒ¯å‡º
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-[1500px] mx-auto px-6 py-10 space-y-10 font-black">
            <!-- çµ±è¨ˆå€ -->
            <div id="stat-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 font-black"></div>

            <!-- ç•¶æ—¥ä½œæ¥­æ‘˜è¦ -->
            <section id="daily-events-section" class="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm hidden animate-fade font-black">
                <h2 class="text-lg font-black flex items-center gap-2 mb-6 text-slate-800">
                    <i data-lucide="calendar-check" class="text-indigo-600"></i> ç•¶æ—¥ä½œæ¥­æ‘˜è¦ - <span id="event-date-display" class="font-mono"></span>
                </h2>
                <div id="daily-events-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <div id="view-inventory" class="space-y-12 font-black">
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-emerald-500 pl-4 uppercase tracking-tighter text-slate-800 font-black">æ¯è±¬ç¹æ®–éšæ®µ</h2>
                    <div id="sow-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-black"></div>
                </section>
                <section id="gilt-section" class="hidden animate-fade font-black">
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-pink-500 pl-4 uppercase tracking-tighter text-slate-800 font-black">æ–°å¥³è±¬ç®¡ç† (åˆ†æµè‚²æˆä¸­)</h2>
                    <div id="gilt-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-black"></div>
                </section>
                <section>
                    <div class="flex items-center justify-between mb-6 border-l-4 border-blue-500 pl-4">
                        <h2 class="text-xl uppercase tracking-tighter text-slate-800 font-black">è‚‰è±¬å­˜æ¬„èˆ‡åˆ†éšæ®µè‚²æˆ</h2>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button id="pig-view-btn-batch" onclick="window.switchPigView('batch')" class="px-4 py-1.5 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all">æ‰¹æ¬¡è¦–è§’</button>
                            <button id="pig-view-btn-house" onclick="window.switchPigView('house')" class="px-4 py-1.5 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all">ç•œèˆè¦–è§’</button>
                        </div>
                    </div>
                    <div id="pig-view-batch" class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black">
                        <div class="overflow-x-auto no-scrollbar font-black">
                            <table class="w-full text-left border-collapse font-black">
                                <thead class="bg-slate-900 text-white font-black text-[11px] uppercase tracking-widest">
                                    <tr>
                                        <th class="p-6">åˆ†å¨©æ—¥æœŸ / ID</th>
                                        <th class="p-6">éšæ®µ/ä½ç½®</th>
                                        <th class="p-6">é€±é½¡</th>
                                        <th class="p-6 text-right text-emerald-400">éšæ®µå…¥èˆ</th>
                                        <th class="p-6 text-right text-pink-400">éšæ®µæ­»äº¡</th>
                                        <th class="p-6 text-right">ç•¶å‰å­˜æ¬„</th>
                                        <th class="p-6 text-center">è‚²æˆç‡</th>
                                        <th class="p-6 text-center">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="pig-table-body" class="divide-y divide-slate-100 text-sm font-black"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="pig-view-house" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                </section>
            </div>

            <div id="view-raw" class="hidden animate-fade font-black">
                <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black">
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center font-black">
                        <h2 class="text-lg font-black flex items-center gap-2"><i data-lucide="database" class="text-indigo-600"></i> å…¨å±€æ•¸æ“šç®¡ç† (åŸºæœ¬ç´€éŒ„é‚„åŸç”¨)</h2>
                        <input type="text" id="raw-search" placeholder="å¿«é€Ÿæœå°‹..." class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-indigo-500/20 font-black">
                    </div>
                    <div class="overflow-x-auto max-h-[600px] no-scrollbar font-black">
                        <table id="raw-table" class="w-full text-left text-[11px] border-collapse font-black"></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="history-edit-modal" class="fixed inset-0 z-[5500] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-sm rounded-[40px] p-8 shadow-2xl animate-fade">
            <div class="bg-indigo-50 p-4 rounded-2xl mb-6 flex items-center gap-3 border border-indigo-100">
                <div class="bg-indigo-600 p-2 rounded-lg text-white"><i data-lucide="edit-3" class="w-5 h-5"></i></div>
                <div><h3 class="font-black text-indigo-900">ä¿®æ­£æ­·å²ç´€éŒ„</h3><p class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider">Modify Record</p></div>
            </div>
            <div id="history-edit-inputs" class="space-y-4 mb-6"></div>
            <div class="flex gap-3">
                <button onclick="window.closeHistoryEditModal()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm active:scale-95 transition-all">å–æ¶ˆ</button>
                <button id="history-save-btn" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-sm active:scale-95 shadow-lg shadow-indigo-600/20 transition-all">ç¢ºèªä¿®æ­£</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 z-[7000] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-sm rounded-[40px] p-8 shadow-2xl text-center animate-fade">
            <h3 class="text-xl font-black mb-4 text-slate-900">ç¢ºå®šè¦æ¸…ç©ºé›²ç«¯è³‡æ–™å—ï¼Ÿ</h3>
            <p class="text-slate-500 text-sm mb-8 leading-relaxed">æ­¤å‹•ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰é›²ç«¯ç•°å‹•ç´€éŒ„ã€æ‰‹å‹•å»ºç«‹çš„æ‰¹æ¬¡ä»¥åŠé›²ç«¯åœ°åŸºï¼Œä¸”ç„¡æ³•é‚„åŸã€‚</p>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm active:scale-95 transition-all">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" onclick="window.executeReset()" class="flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black text-sm active:scale-95 shadow-lg shadow-rose-600/20 transition-all">ç¢ºå®šé‡ç½®</button>
            </div>
        </div>
    </div>

    <div id="sale-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-2xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black">
            <div class="bg-amber-600 p-10 text-white flex justify-between items-center font-black">
                <div><h3 class="text-3xl font-black tracking-tighter">æ™ºæ…§å‡ºè±¬éŒ„å…¥</h3><p class="text-amber-200 text-xs font-bold uppercase mt-1">Batch Sale & ADG Tracking</p></div>
                <button onclick="window.closeSaleModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black">
                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 font-black">
                    <label class="text-[10px] text-slate-400 uppercase mb-2 block font-black">æœ¬æ¬¡å‡ºè±¬äº¤æ˜“æ—¥æœŸ</label>
                    <input type="date" id="sale-date" class="w-full bg-white border-2 border-slate-100 rounded-2xl p-4 text-xl font-black outline-none focus:border-amber-500 font-black">
                </div>
                <div>
                    <label class="text-[10px] text-slate-400 uppercase mb-4 block font-black">é»é¸ä¸‹æ–¹æ‰¹æ¬¡ä»¥é¸å– (è‡ªå‹•éæ¿¾é©é½¡æ‰¹æ¬¡)</label>
                    <div id="sale-batch-list" class="grid grid-cols-2 gap-3 max-h-[150px] overflow-y-auto no-scrollbar font-black"></div>
                </div>
                <div id="selected-sale-container" class="hidden animate-fade space-y-4 font-black">
                    <div class="bg-amber-50 p-6 rounded-3xl border-2 border-amber-200 relative font-black">
                        <div class="flex justify-between items-start mb-4 font-black">
                            <div><p class="text-[10px] text-amber-600 uppercase font-black">å·²é¸æ‰¹æ¬¡</p><h4 id="selected-sale-id" class="text-2xl font-black text-slate-900 tracking-tighter"></h4><p id="selected-sale-hint" class="text-[10px] text-slate-400 font-bold italic"></p></div>
                            <div class="bg-white px-3 py-1 rounded-full text-amber-600 border border-amber-100 text-xs font-black">åœ¨èˆé¤˜æ•¸: <span id="selected-sale-max">0</span> é ­</div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 font-black">
                            <div><label class="text-[10px] text-slate-400 uppercase mb-2 block">æœ¬æ¬¡å‡ºè±¬é ­æ•¸</label><input type="number" id="sale-count" placeholder="0" class="w-full p-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-amber-500 font-black text-2xl"></div>
                            <div><label class="text-[10px] text-slate-400 uppercase mb-2 block">å¹³å‡é‡é‡ (kg)</label><input type="number" step="0.1" id="sale-avg-weight" placeholder="0.0" class="w-full p-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-amber-500 font-black text-2xl"></div>
                        </div>
                    </div>
                    <button onclick="window.submitSale()" class="w-full py-6 bg-amber-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black">ç¢ºèªä¸¦è¨˜éŒ„æœ¬æ¬¡äº¤æ˜“</button>
                </div>
            </div>
        </div>
    </div>

    <div id="analysis-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 md:p-10 hidden font-black">
        <div class="bg-white w-full max-w-5xl rounded-[60px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade font-black">
            <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-white font-black">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600 p-4 rounded-3xl text-white shadow-lg font-black"><i data-lucide="bar-chart-3"></i></div>
                    <div><div class="flex items-baseline gap-3"><h3 id="analysis-batch-id" class="text-3xl font-black tracking-tighter">BATCH-ID</h3><span id="analysis-total-rate" class="text-sm font-black bg-slate-900 text-white px-3 py-1 rounded-full">å…¨æœŸè‚²æˆ 0%</span></div><p class="text-slate-400 text-xs font-black uppercase mt-1">Efficiency & Modification Logs</p></div>
                </div>
                <button onclick="window.closeAnalysisModal()" class="p-4 text-slate-300 hover:text-rose-500 transition-all font-black"><i data-lucide="x" class="w-10 h-10 font-black"></i></button>
            </div>
            <div class="p-10 overflow-y-auto no-scrollbar space-y-10 font-black">
                <div class="grid grid-cols-3 gap-6 font-black">
                    <div id="box-nursery" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50"><p class="text-[10px] text-slate-400 uppercase mb-2">ä¿è‚²æœŸ (W4-W11)</p><p id="rate-nursery" class="text-4xl font-black">0%</p><p id="status-nursery" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block">ç­‰å¾…ä¸­</p></div>
                    <div id="box-small" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black"><p class="text-[10px] text-slate-400 uppercase mb-2">å°è±¬æœŸ (W11-W19)</p><p id="rate-small" class="text-4xl font-black">0%</p><p id="status-small" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block">ç­‰å¾…ä¸­</p></div>
                    <div id="box-medium" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black"><p class="text-[10px] text-slate-400 uppercase mb-2">ä¸­è±¬æœŸ (W19-W24)</p><p id="rate-medium" class="text-4xl font-black">0%</p><p id="status-medium" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block">ç­‰å¾…ä¸­</p></div>
                </div>
                <div class="bg-white rounded-[40px] border-2 border-slate-50 p-10 font-black">
                    <h4 class="text-lg font-black mb-8 flex items-center gap-2"><i data-lucide="trending-up" class="text-blue-600"></i> ç”Ÿé•·é€±è¶¨å‹¢åˆ†æ</h4>
                    <div style="height: 400px; position: relative;"><canvas id="lifecycle-chart"></canvas></div>
                </div>
                <div id="analysis-history-list" class="mt-8 font-black"></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-[5000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-md rounded-[48px] shadow-2xl overflow-hidden animate-fade font-black">
            <div id="modal-header-color" class="bg-indigo-600 p-8 text-white flex justify-between items-center font-black">
                <div><h3 id="modal-batch-id" class="text-2xl font-black italic">BATCH ID</h3><p class="text-indigo-200 text-[10px] uppercase font-bold tracking-widest mt-1">Modification Engine</p></div>
                <button onclick="window.closeEditModal()" class="p-2 hover:bg-white/20 rounded-full transition-all font-black"><i data-lucide="x" class="font-black"></i></button>
            </div>
            <div class="p-8 space-y-6 font-black">
                <div class="bg-orange-50 p-5 rounded-3xl border border-orange-100 font-black"><label class="text-[10px] text-orange-600 uppercase mb-2 block tracking-widest">ç•°å‹•ç´€éŒ„æ—¥æœŸ</label><input type="date" id="modal-date" class="w-full bg-white border-2 border-transparent focus:border-orange-400 outline-none p-3 rounded-2xl text-xl font-black transition-all"></div>
                <div id="modal-inputs" class="space-y-4 font-black"></div>
                <button id="save-loss-btn" onclick="window.saveLossRecord()" class="w-full py-6 bg-slate-900 text-white rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all uppercase">ç¢ºèªå„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
            </div>
        </div>
    </div>

    <div id="mating-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black">
            <div class="bg-pink-600 p-10 text-white flex justify-between items-center font-black">
                <div><h3 class="text-3xl font-black tracking-tighter">æ™ºæ…§é…ç¨®éŒ„å…¥</h3><p class="text-pink-200 text-xs font-bold uppercase mt-1">Suggested Batch Planning</p></div>
                <button onclick="window.closeSmartMatingModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black">
                <div class="grid grid-cols-2 gap-6 font-black">
                    <div class="col-span-2"><label class="text-[10px] text-slate-400 uppercase mb-2 block">æ¨è–¦æ‰¹æ¬¡ ID</label><input type="text" id="mating-id" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-2xl text-pink-600"></div>
                    <div><label class="text-[10px] text-slate-400 uppercase mb-2 block">é…ç¨®æ—¥æœŸ</label><input type="date" id="mating-date" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-xl"></div>
                    <div><label class="text-[10px] text-slate-400 uppercase mb-2 block">é…ç¨®æ¯è±¬é ­æ•¸</label><input type="number" id="mating-count" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-2xl"></div>
                    <div class="col-span-2 bg-slate-50 p-6 rounded-3xl border border-slate-100 font-black"><div class="flex justify-between text-xs font-black text-slate-400"><span>é è¨ˆåˆ†å¨©æ—¥æœŸ</span><span id="suggest-birth" class="text-slate-900">å°šæœªè¨ˆç®—</span></div></div>
                </div>
                <button onclick="window.submitSmartMating()" class="w-full py-6 bg-pink-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black">å»ºç«‹æ‰¹æ¬¡ä¸¦å¯«å…¥é›²ç«¯</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-2xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black">
            <div class="bg-blue-600 p-10 text-white flex justify-between items-center font-black">
                <div><h3 class="text-3xl font-black tracking-tighter">æ™ºæ…§è½‰èˆç´€éŒ„</h3><p class="text-blue-200 text-xs font-bold uppercase mt-1">Smart Phase Transfer Management</p></div>
                <button onclick="window.closeTransferModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black">
                <div><label class="text-[10px] text-slate-400 uppercase mb-4 block">é¸æ“‡è½‰å…¥å°è±¡æ‰¹æ¬¡</label><div id="transfer-batch-list" class="grid grid-cols-2 gap-3 max-h-[200px] overflow-y-auto no-scrollbar font-black"></div></div>
                <div class="grid grid-cols-2 gap-6 font-black">
                    <div><label class="text-[10px] text-slate-400 uppercase mb-2 block">ç›®æ¨™ç•œèˆ (åŸºæ–¼æ—¥é½¡æ™ºæ…§æ¨è–¦)</label><select id="transfer-target" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-blue-500 font-black"><option value="">è«‹å…ˆé¸å–æ‰¹æ¬¡</option></select></div>
                    <div><label class="text-[10px] text-slate-400 uppercase mb-2 block">å¯¦éš›è½‰å…¥æ•¸é‡</label><input type="number" id="transfer-count" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-blue-500 font-black text-2xl"></div>
                </div>
                <button onclick="window.submitTransfer()" class="w-full py-6 bg-blue-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black">æ›´æ–°åŸºæœ¬è³‡æ–™èˆ‡ç•œèˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs, writeBatch, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *** é‡è¦ï¼šå¼·åˆ¶çµ±ä¸€è³‡æ–™åº« IDï¼Œå¯¦ç¾å…¨åŒæ­¥ï¼Œä¸¦ä¸”åªåœ¨æ­¤è™•å®šç¾©ä¸€æ¬¡ ***
        function getAppId() {
            if (typeof window !== 'undefined' && window.__app_id) return window.__app_id;
            return "yonglong-production-main";
        }
        const APP_ID = getAppId();

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBd-t01YqCEJorVA3Pguz_z2qfOIKhVJ28", authDomain: "yonglong-farm.firebaseapp.com", projectId: "yonglong-farm", storageBucket: "yonglong-farm.firebasestorage.app", messagingSenderId: "420882808146", appId: "1:420882808146:web:6086ac11d1323936418e8b"
        };
        const PASSCODE = "YL2025";
        const WEANING_DAYS = 28;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const CONFIG = {
            BATCH_INTERVAL: 21, ANCHOR: new Date('2025-02-04'), GESTATION: 115, STAGES: { L: 28, N: 77, S: 133, M: 168, B: 196 }, TOTAL_BATCHES: 19,
            BASIC_HEADERS: ['æ‰¹æ¬¡','é…ç¨®æ—¥æœŸ','åˆ†å¨©æ—¥æœŸ','é…ç¨®æ•¸','é åˆ†å¨©æ•¸','æ´»ä»”æ•¸','é›¢ä¹³æ•¸','ä¿èˆ','å…¥ä¿è‚²èˆè±¬é‡','å°èˆ','å…¥æ–°å¥³èˆç¨®è±¬é‡','å…¥å°è±¬èˆè±¬é‡','ä¸­èˆ','å…¥ä¸­è±¬èˆè±¬é‡','å¤§èˆ','å…¥å¤§è±¬èˆè±¬é‡','å‡ºè±¬é‡','å¹³å‡é‡']
        };

        let chartInstance = null;
        let excelData = [];
        let manualBatches = {};
        let cloudRecords = {};
        let selectedDate = new Date().toISOString().split('T')[0];
        let editingBatchId = null;
        let user = null;
        let pigViewMode = 'batch';
        let editingHistoryDocId = null; 
        let editingHistoryType = null;
        let currentAnalysisBatchId = null;

        function safeStr(v) {
            if (v instanceof Date) return v.toISOString().split('T')[0];
            if (typeof v === 'number' && v > 40000) return new Date((v - 25569) * 86400 * 1000).toISOString().split('T')[0];
            const s = String(v ?? "").trim();
            if (s.match(/^\d{4}-\d{2}-\d{2}T/)) { return s.split('T')[0]; }
            return s;
        }

        function cleanNum(v) { return isNaN(parseFloat(v)) ? 0 : parseFloat(v); }
        
        function calculateStatus() {
            const selDate = new Date(selectedDate);
            const anchorDate = new Date(CONFIG.ANCHOR);
            const diffDays = (selDate.getTime() - anchorDate.getTime()) / (86400000);
            const cyclesToSelected = Math.floor(diffDays / CONFIG.BATCH_INTERVAL);
            const pivotDate = new Date(anchorDate);
            pivotDate.setDate(pivotDate.getDate() + (cyclesToSelected * CONFIG.BATCH_INTERVAL));

            return Array.from({ length: CONFIG.TOTAL_BATCHES }).map((_, i) => {
                const theoMating = new Date(pivotDate);
                theoMating.setDate(theoMating.getDate() - (i * CONFIG.BATCH_INTERVAL));
                const theoFarrowing = new Date(theoMating.getTime() + CONFIG.GESTATION * 86400000);
                const mYear = theoFarrowing.getFullYear(); 
                const cycleDiff = Math.round((theoMating.getTime() - anchorDate.getTime()) / (CONFIG.BATCH_INTERVAL * 86400000));
                const shortId = `G${((Math.floor(cycleDiff/7)%9+9)%9+1)}${((cycleDiff%7+7)%7+1)}`;
                const fullId = `${mYear}-${shortId}`;
                const excelMatch = excelData.find(d => String(d['æ‰¹æ¬¡'] || '').includes(shortId) && new Date(d['åˆ†å¨©æ—¥æœŸ']).getFullYear() === mYear);
                const manualMatch = manualBatches[fullId] || (excelMatch ? manualBatches[excelMatch['æ‰¹æ¬¡']] : null);
                const match = (excelMatch || manualMatch) ? { ...(excelMatch || {}), ...(manualMatch || {}) } : null;
                const basicRow = match ? {
                    'æ‰¹æ¬¡': match['æ‰¹æ¬¡'] || match.id || fullId, 'é…ç¨®æ—¥æœŸ': safeStr(match['é…ç¨®æ—¥æœŸ']), 'åˆ†å¨©æ—¥æœŸ': safeStr(match['åˆ†å¨©æ—¥æœŸ']), 'é…ç¨®æ•¸': cleanNum(match['é…ç¨®æ•¸']), 'é åˆ†å¨©æ•¸': cleanNum(match['é åˆ†å¨©æ•¸']), 'æ´»ä»”æ•¸': cleanNum(match['æ´»ä»”æ•¸']), 'é›¢ä¹³æ•¸': cleanNum(match['é›¢ä¹³æ•¸']), 'ä¿èˆ': match['ä¿èˆ'] || 'å¾…å®š', 'å…¥ä¿è‚²èˆè±¬é‡': cleanNum(match['å…¥ä¿è‚²èˆè±¬é‡']), 'å°èˆ': match['å°èˆ'] || 'å¾…å®š', 'å…¥æ–°å¥³èˆç¨®è±¬é‡': cleanNum(match['å…¥æ–°å¥³èˆç¨®è±¬é‡']), 'å…¥å°è±¬èˆè±¬é‡': cleanNum(match['å…¥å°è±¬èˆè±¬é‡']), 'ä¸­èˆ': match['ä¸­èˆ'] || 'å¾…å®š', 'å…¥ä¸­è±¬èˆè±¬é‡': cleanNum(match['å…¥ä¸­è±¬èˆè±¬é‡']), 'å¤§èˆ': match['å¤§èˆ'] || 'å¾…å®š', 'å…¥å¤§è±¬èˆè±¬é‡': cleanNum(match['å…¥å¤§è±¬èˆè±¬é‡']), 'å‡ºè±¬é‡': cleanNum(match['å‡ºè±¬é‡']), 'å¹³å‡é‡': cleanNum(match['å¹³å‡é‡']), 'transDate_nursery': match['transDate_nursery'], 'transDate_small': match['transDate_small'], 'transDate_medium': match['transDate_medium'], 'transDate_large': match['transDate_large']
                } : null;
                const matingDateStr = basicRow ? basicRow['é…ç¨®æ—¥æœŸ'] : safeStr(theoMating);
                const farrowDateStr = basicRow ? basicRow['åˆ†å¨©æ—¥æœŸ'] : safeStr(theoFarrowing);
                const weekAge = ((selDate.getTime() - new Date(farrowDateStr).getTime()) / (86400000 * 7)).toFixed(1);
                const history = cloudRecords[basicRow?.['æ‰¹æ¬¡'] || fullId] || [];
                const totals = history.reduce((acc, rec) => {
                    if(new Date(rec.date) <= selDate) { acc.abortion += (rec.abortion || 0); acc.sow += (rec.sowDeath || 0); acc.negative += (rec.negative || 0); acc.returnEstrus += (rec.returnEstrus || 0); if(new Date(rec.date).getTime() >= new Date(farrowDateStr).getTime()) { acc.stagePig += (rec.pigDeath || 0); acc.soldCount += (rec.soldCount || 0); } if (rec.avgWeight > 0) acc.latestAvgWeight = rec.avgWeight; }
                    return acc;
                }, { abortion: 0, sow: 0, negative: 0, returnEstrus: 0, stagePig: 0, soldCount: 0, latestAvgWeight: 0 });
                return { id: basicRow ? basicRow['æ‰¹æ¬¡'] : fullId, matingDate: matingDateStr, farrowingDate: farrowDateStr, stage: "å…¨é›²ç«¯åŒæ­¥", location: basicRow?.['å¤§èˆ'] || "ç‰§å ´å…§", headcount: match ? 100 : 0, nurseryBase: 100, loss: totals, isActual: !!basicRow, type: i < 7 ? "æ¯è±¬" : "è‚‰è±¬", weekAge, matingCount: basicRow ? basicRow['é…ç¨®æ•¸'] : 0, giltCount: basicRow ? basicRow['å…¥æ–°å¥³èˆç¨®è±¬é‡'] : 0, soldCount: totals.soldCount, avgWeight: totals.latestAvgWeight || (basicRow ? basicRow['å¹³å‡é‡'] : 0), estFarrowing: (basicRow ? basicRow['é…ç¨®æ•¸'] : 0) - totals.abortion - totals.sow, history, basicRow };
            });
        }

        function renderFn() {
            try {
                const status = calculateStatus();
                const selDateObj = new Date(selectedDate);
                const updateUI = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                updateUI('stat-farrow', status.filter(b => b.type === "æ¯è±¬").reduce((a,b) => a + b.estFarrowing, 0));
                updateUI('stat-headcount', status.filter(b => b.type === "è‚‰è±¬").reduce((a,b) => a + (b.isActual ? 100 : 0), 0).toLocaleString());
                const specialProblem = manualBatches['SPECIAL_PROBLEM'] || { count: 0, date: 'ç„¡ç´€éŒ„' };
                const specialRegumate = manualBatches['SPECIAL_REGUMATE'] || { count: 0, date: 'ç„¡ç´€éŒ„' };
                const sowCont = document.getElementById('sow-container');
                if (sowCont) {
                    const displaySows = status.filter(b => Math.floor((selDateObj - new Date(b.farrowingDate)) / 86400000) < WEANING_DAYS).slice(0, 7);
                    sowCont.innerHTML = `<div class="bg-white p-6 rounded-[32px] border-2 border-slate-200 shadow-sm font-black flex flex-col justify-between"><h4 class="text-lg mb-4 border-b border-slate-100 pb-2">ç‰¹æ®Šç®¡ç†çœ‹æ¿</h4><div class="flex justify-between items-center mb-2"><div><p class="text-[9px] text-rose-400">å•é¡Œæ¯è±¬</p><p class="text-2xl text-rose-600">${specialProblem.count} <small class="text-xs">é ­</small></p></div><button onclick="window.openSpecialEdit('SPECIAL_PROBLEM', 'å•é¡Œæ¯è±¬')" class="p-2 bg-rose-50 rounded-xl text-rose-600 shadow-sm"><i data-lucide="edit-3" class="w-4 h-4"></i></button></div><div class="flex justify-between items-center pt-2 border-t border-dashed border-slate-100"><div><p class="text-[9px] text-purple-400">å¾‹é½Šåª’æ¯è±¬</p><p class="text-2xl text-purple-600">${specialRegumate.count} <small class="text-xs">é ­</small></p></div><button onclick="window.openSpecialEdit('SPECIAL_REGUMATE', 'å¾‹é½Šåª’æ¯è±¬')" class="p-2 bg-purple-50 rounded-xl text-purple-600 shadow-sm"><i data-lucide="edit-3" class="w-4 h-4"></i></button></div></div>` + displaySows.map(b => `<div class="bg-white p-6 rounded-[32px] border-2 shadow-sm ${b.isActual ? 'border-indigo-200' : 'border-slate-50 opacity-60'} font-black"><div class="flex justify-between items-start mb-4"><div><p class="text-[9px] text-slate-400 italic">é…ç¨®: ${b.matingDate}</p><p class="text-[9px] text-slate-400 italic">åˆ†å¨©: ${b.farrowingDate}</p><h4 class="font-black text-lg text-slate-800">${b.id}</h4></div><button onclick="window.openEditModal('${b.id}', 'sow')" class="p-2 bg-slate-50 rounded-xl hover:bg-indigo-50 text-indigo-600 shadow-sm"><i data-lucide="edit-3" class="w-4 h-4"></i></button></div><div class="pt-4 border-t-2 border-dashed border-slate-100 text-center font-black"><p class="text-[10px] text-slate-400 uppercase mb-1">é è¨ˆåˆ†å¨©</p><p class="text-5xl text-indigo-600 tracking-tighter">${b.estFarrowing} <small class="text-xs">é ­</small></p></div></div>`).join('');
                }
                const pigBatches = status.filter(b => Math.floor((selDateObj - new Date(b.farrowingDate)) / 86400000) >= WEANING_DAYS);
                const pigCont = document.getElementById('pig-table-body');
                if (pigCont) { pigCont.innerHTML = pigBatches.map(b => `<tr class="hover:bg-slate-50 transition-all font-black"><td class="p-6"><div><p class="font-mono text-slate-900">${b.id}</p><p class="text-[9px] text-slate-400 italic">${b.farrowingDate}</p></div></td><td class="p-6"><span class="text-[10px] bg-slate-100 px-2 py-1 rounded-lg mr-2 border border-slate-200">${b.weekAge}W</span></td><td class="p-6 text-right text-lg text-slate-900">${b.headcount}</td><td class="p-6 text-center"><div class="flex justify-center gap-1.5"><button onclick="window.openEditModal('${b.id}', 'pig')" class="p-2 hover:bg-emerald-50 text-emerald-600 rounded-full active:scale-90 transition-all"><i data-lucide="edit-3" class="w-5 h-5"></i></button><button onclick='window.openAnalysisModal("${encodeURIComponent(JSON.stringify(b))}")' class="p-2 hover:bg-blue-50 text-blue-600 rounded-full active:scale-90 transition-all"><i data-lucide="line-chart" class="w-5 h-5"></i></button></div></td></tr>`).join(''); }
                lucide.createIcons();
                document.getElementById('week-display').innerText = `é¸å®šæ—¥ç‚º ${selectedDate}`;
            } catch(e) { console.error("Render error:", e); }
        }

        window.listenCloud = function() {
            if (!user) return;
            const badge = document.getElementById('db-id-display');
            if (badge) {
                badge.innerText = (APP_ID === "yonglong-production-main") ? "ğŸ”µ æ­£å¼é€£ç·š" : "ğŸŸ¢ æ¸¬è©¦é€£ç·š";
                badge.classList.remove('hidden');
            }
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords'), (snap) => {
                const newRecs = {}; snap.forEach(d => { const data = d.data(); data.docId = d.id; if(!newRecs[data.batchId]) newRecs[data.batchId] = []; newRecs[data.batchId].push(data); });
                cloudRecords = newRecs; renderFn();
                document.getElementById('last-sync').innerText = `ä¸Šæ¬¡åŒæ­¥: ${new Date().toLocaleTimeString()}`;
            }, (err) => console.warn("Firestore Records Denied:", err.message));
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches'), (snap) => {
                const newBatches = {}; snap.forEach(d => { newBatches[d.id] = d.data(); });
                manualBatches = newBatches; renderFn();
            }, (err) => console.warn("Firestore Batches Denied:", err.message));
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'baseRecords'), (snap) => {
                excelData = []; snap.forEach(d => { excelData.push(d.data()); });
                if (excelData.length > 0) document.getElementById('excel-count').innerHTML = `<i data-lucide="cloud" class="w-3 h-3 text-blue-400"></i> é›²ç«¯åœ°åŸºï¼š${excelData.length} æ‰¹`;
                renderFn();
            }, (err) => console.warn("Firestore Base Records Denied:", err.message));
        };

        window.exportUniversalBackup = () => {
            try {
                if (typeof XLSX === 'undefined') return alert("â³ å¼•æ“è¼‰å…¥ä¸­...");
                const allIds = new Set(); excelData.forEach(r => { if(r['æ‰¹æ¬¡']) allIds.add(String(r['æ‰¹æ¬¡'])); }); Object.keys(manualBatches).forEach(id => allIds.add(id));
                const fullBasicData = Array.from(allIds).map(id => {
                    const manual = manualBatches[id]; const excel = excelData.find(r => String(r['æ‰¹æ¬¡']) === id); const row = {};
                    CONFIG.BASIC_HEADERS.forEach(h => { let val = (manual && manual[h] !== undefined) ? manual[h] : (excel && excel[h] !== undefined ? excel[h] : ""); row[h] = val; });
                    return row;
                });
                const modificationLogs = []; Object.keys(cloudRecords).forEach(bid => cloudRecords[bid].forEach(rec => modificationLogs.push({ 'æ‰¹æ¬¡ID': bid, 'ç´€éŒ„æ—¥æœŸ': rec.date, 'å‡ºè±¬é‡': rec.soldCount || 0, 'æ›´æ–°æ™‚é–“': rec.updatedAt })));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fullBasicData), "åŸºæœ¬ç´€éŒ„"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(modificationLogs), "ä¿®æ”¹ç´€éŒ„"); XLSX.writeFile(wb, `æ°¸éš†ç‰§å ´æ•´åˆå…¨å±€äº¤æ˜“å‚™ä»½_${selectedDate}.xlsx`);
                window.showMessage("âœ… å‚™ä»½å·²ç”¢å‡º (æœ¬åœ°å„ªå…ˆæ‰“åŒ…)");
            } catch(e) { window.showMessage("âŒ åŒ¯å‡ºå¤±æ•—ï¼š" + e.message, "error"); }
        };

        window.initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (error) { console.error("Auth Failed:", error); }
        };

        window.onload = () => {
            document.getElementById('date-picker').addEventListener('change', (e) => { selectedDate = e.target.value; renderFn(); });
            onAuthStateChanged(auth, (u) => { user = u; if (user) window.listenCloud(); });
            window.initAuth();
        };

        window.switchView = (m) => {
            document.getElementById('view-inventory').classList.toggle('hidden', m !== 'inventory');
            document.getElementById('view-raw').classList.toggle('hidden', m !== 'raw');
        };

        window.handleFileUpload = async function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array', cellDates: true });
                const parsedData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" }).map(r => {
                    const nr = {}; Object.keys(r).forEach(k => nr[k.trim()] = r[k]);
                    ['é…ç¨®æ—¥æœŸ', 'åˆ†å¨©æ—¥æœŸ'].forEach(k => { if (nr[k] instanceof Date) nr[k] = nr[k].toISOString().split('T')[0]; });
                    return nr;
                });
                excelData = parsedData; renderFn();
                const baseRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'baseRecords');
                for (let i = 0; i < parsedData.length; i += 400) {
                    const batchWrite = writeBatch(db);
                    parsedData.slice(i, i + 400).forEach(row => { if (row['æ‰¹æ¬¡']) batchWrite.set(doc(db, 'artifacts', APP_ID, 'public', 'data', 'baseRecords', String(row['æ‰¹æ¬¡'])), row); });
                    await batchWrite.commit();
                }
                window.showMessage("âœ… é›²ç«¯åŒæ­¥å®Œæˆ");
            };
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>

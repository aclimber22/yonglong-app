<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永隆智慧管理 v9.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- 使用 Chart.js 處理圖表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-black { font-weight: 900 !important; }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        tr:hover { background-color: rgba(241, 245, 249, 0.8); }
        :fullscreen main { padding: 2rem 4rem; }
    </style>
</head>
<body class="min-h-screen pb-24 font-black">

    <!-- 1. 密碼驗證層 -->
    <div id="auth-overlay" class="fixed inset-0 z-[5000] bg-slate-900 flex items-center justify-center p-6 transition-all duration-700">
        <div class="max-w-md w-full bg-white rounded-[48px] p-10 shadow-2xl text-center animate-fade font-black">
            <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-8 font-black">
                <i data-lucide="shield-check" class="w-10 h-10 font-black"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter text-slate-900 font-black font-black">永隆智慧中心</h2>
            <p class="text-slate-400 font-bold text-sm mb-8 uppercase tracking-widest font-black">Master Passcode Required</p>
            <input type="password" id="passcode-input" placeholder="••••••" 
                   class="w-full px-6 py-5 bg-slate-50 rounded-2xl text-center text-3xl font-black mb-8 outline-none border-2 border-transparent focus:border-indigo-500 tracking-[0.3em] transition-all font-black font-black">
            <button onclick="window.checkPasscode()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-lg active:scale-95 shadow-xl hover:bg-indigo-700 transition-all uppercase font-black font-black">進入管理系統</button>
        </div>
    </div>

    <!-- 2. 通知提醒 -->
    <div id="msg-box" class="fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black hidden animate-fade text-white text-center min-w-[300px]"></div>

    <!-- 3. 主應用介面 -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700 font-black">
        <div class="bg-slate-800 text-slate-400 px-6 py-2 text-[10px] flex justify-between items-center border-b border-white/5 font-black">
            <div class="flex items-center gap-4 font-black">
                <span id="cloud-status" class="flex items-center gap-1.5 font-black"><i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> 雲端連線中...</span>
                <span id="excel-count" class="flex items-center gap-1.5 font-black"><i data-lucide="file-warning" class="w-3 h-3"></i> 尚未載入檔案</span>
            </div>
            <div class="flex items-center gap-4 font-black">
                <button onclick="window.clearCloudDatabase()" class="text-rose-400 hover:text-rose-300 transition-colors uppercase cursor-pointer font-black">[ ⚠️ 重置雲端資料 ]</button>
                <span id="last-sync" class="opacity-60 italic text-[9px] font-black"></span>
            </div>
        </div>

        <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-xl border-b border-slate-200 px-6 py-5 font-black font-black">
            <div class="max-w-[1500px] mx-auto flex flex-col md:flex-row items-center justify-between gap-6 font-black font-black font-black">
                <div class="flex items-center gap-4 font-black font-black">
                    <div class="bg-indigo-600 p-2.5 rounded-2xl shadow-lg text-white font-black font-black font-black"><i data-lucide="activity"></i></div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight uppercase text-slate-900 font-black font-black font-black">永隆智慧管理 <span class="text-indigo-600 italic font-black">v9.8</span></h1>
                        <div class="flex items-center gap-2 font-black font-black">
                            <span id="week-display" class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-50 text-indigo-700 shadow-sm font-black">載入中</span>
                            <input type="date" id="date-picker" class="text-[11px] font-black text-slate-400 bg-transparent border-none outline-none cursor-pointer hover:text-indigo-600 font-black font-black font-black">
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl font-black font-black">
                    <button id="tab-inventory" onclick="window.switchView('inventory')" class="px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all font-black">生產監控</button>
                    <button id="tab-raw" onclick="window.switchView('raw')" class="px-5 py-2 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all font-black font-black">原始數據對齊</button>
                </div>

                <div class="flex items-center gap-3 font-black font-black">
                    <button onclick="window.toggleFullScreen()" class="bg-slate-100 text-slate-600 p-2.5 rounded-xl hover:bg-slate-200 transition-all shadow-sm font-black font-black font-black">
                        <i id="fullscreen-icon" data-lucide="maximize" class="w-4 h-4 font-black font-black"></i>
                    </button>
                    <div class="h-6 w-[1px] bg-slate-200 mx-1 font-black"></div>
                    <button onclick="window.openSmartMatingModal()" class="bg-pink-50 text-pink-600 border border-pink-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-pink-100 flex items-center gap-2 font-black font-black">
                        <i data-lucide="plus-circle" class="w-4 h-4 font-black"></i>智慧配種
                    </button>
                    <button onclick="window.openTransferModal()" class="bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-blue-100 flex items-center gap-2 font-black font-black">
                        <i data-lucide="shuffle" class="w-4 h-4 font-black"></i>新增轉舍
                    </button>
                    <button onclick="window.openSaleModal()" class="bg-amber-50 text-amber-600 border border-amber-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-amber-100 flex items-center gap-2 font-black font-black font-black">
                        <i data-lucide="shopping-cart" class="w-4 h-4 font-black font-black"></i>智慧出豬
                    </button>
                    <label class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-xl cursor-pointer transition-all text-xs font-black shadow-lg flex items-center gap-2 active:scale-95 group font-black font-black">
                        <i data-lucide="upload" class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform font-black"></i>讀入數據<input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    </label>
                    <button onclick="window.exportUniversalBackup()" class="bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-blue-100 flex items-center gap-2 font-black font-black font-black">
                        <i data-lucide="shield-check" class="w-4 h-4 text-emerald-500 font-black"></i>整合備份匯出
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-[1500px] mx-auto px-6 py-10 space-y-10 font-black font-black">
            <!-- 統計區 -->
            <div id="stat-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 font-black font-black font-black">
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black">預計分娩總數</p>
                        <div class="flex items-baseline gap-1 font-black font-black">
                            <span id="stat-farrow" class="text-2xl text-blue-600 font-black">0</span><span class="text-[10px] text-slate-400 font-black">頭</span>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-2xl text-blue-600 font-black"><i data-lucide="baby"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black font-black font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black">選取日存欄計</p>
                        <div class="flex items-baseline gap-1 font-black font-black font-black">
                            <span id="stat-headcount" class="text-2xl text-orange-600 font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black">頭</span>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-2xl text-orange-600 font-black"><i data-lucide="trending-up"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black font-black font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black font-black">成功匹配批次</p>
                        <div class="flex items-baseline gap-1 font-black font-black font-black">
                            <span id="stat-match" class="text-2xl text-emerald-600 font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black">批</span>
                        </div>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-2xl text-emerald-600 font-black"><i data-lucide="check-circle-2"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black font-black font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black font-black font-black">雲端異動筆數</p>
                        <div class="flex items-baseline gap-1 font-black font-black font-black">
                            <span id="stat-cloud" class="text-2xl text-indigo-600 font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black">筆</span>
                        </div>
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-2xl text-indigo-600 font-black"><i data-lucide="cloud"></i></div>
                </div>
            </div>

            <div id="view-inventory" class="space-y-12 font-black">
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-emerald-500 pl-4 uppercase tracking-tighter text-slate-800 font-black">母豬繁殖階段</h2>
                    <div id="sow-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-black font-black font-black font-black font-black"></div>
                </section>
                <section id="gilt-section" class="hidden animate-fade font-black font-black">
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-pink-500 pl-4 uppercase tracking-tighter text-slate-800 font-black font-black">新女豬管理 (分流育成中)</h2>
                    <div id="gilt-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-black font-black font-black font-black font-black font-black"></div>
                </section>
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-blue-500 pl-4 uppercase tracking-tighter text-slate-800 font-black font-black">肉豬存欄與分階段育成</h2>
                    <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black font-black">
                        <div class="overflow-x-auto no-scrollbar font-black">
                            <table class="w-full text-left border-collapse font-black font-black font-black">
                                <thead class="bg-slate-900 text-white font-black text-[11px] uppercase tracking-widest font-black font-black font-black font-black font-black font-black font-black font-black">
                                    <tr>
                                        <th class="p-6">分娩日期 / ID</th>
                                        <th class="p-6">階段/位置</th>
                                        <th class="p-6">週齡</th>
                                        <th class="p-6 text-right text-emerald-400">階段入舍</th>
                                        <th class="p-6 text-right text-pink-400">階段死亡</th>
                                        <th class="p-6 text-right">當前存欄</th>
                                        <th class="p-6 text-center">育成率</th>
                                        <th class="p-6 text-center">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="pig-table-body" class="divide-y divide-slate-100 text-sm font-black font-black font-black font-black font-black font-black"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <div id="view-raw" class="hidden animate-fade font-black font-black">
                <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black font-black font-black">
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center font-black font-black font-black font-black font-black font-black font-black font-black">
                        <h2 class="text-lg font-black flex items-center gap-2 font-black font-black font-black font-black font-black font-black font-black font-black font-black"><i data-lucide="database" class="text-indigo-600 font-black font-black"></i> 全局數據管理 (基本紀錄還原用)</h2>
                        <input type="text" id="raw-search" placeholder="快速搜尋..." class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-indigo-500/20 font-black font-black font-black font-black font-black font-black font-black">
                    </div>
                    <div class="overflow-x-auto max-h-[600px] no-scrollbar font-black font-black font-black font-black">
                        <table id="raw-table" class="w-full text-left text-[11px] border-collapse font-black font-black font-black"></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- 智慧出豬 Modal -->
    <div id="sale-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-2xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black font-black">
            <div class="bg-amber-600 p-10 text-white flex justify-between items-center font-black font-black font-black">
                <div><h3 class="text-3xl font-black tracking-tighter">智慧出豬錄入</h3><p class="text-amber-200 text-xs font-bold uppercase mt-1">Batch Sale & ADG Tracking</p></div>
                <button onclick="window.closeSaleModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black font-black font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black font-black font-black font-black">
                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 font-black font-black font-black">
                    <label class="text-[10px] text-slate-400 uppercase mb-2 block font-black">本次出豬交易日期</label>
                    <input type="date" id="sale-date" class="w-full bg-white border-2 border-slate-100 rounded-2xl p-4 text-xl font-black outline-none focus:border-amber-500 font-black font-black font-black font-black">
                </div>
                <div>
                    <label class="text-[10px] text-slate-400 uppercase mb-4 block font-black font-black font-black font-black">點選下方批次以選取 (自動過濾適齡批次)</label>
                    <div id="sale-batch-list" class="grid grid-cols-2 gap-3 max-h-[150px] overflow-y-auto no-scrollbar font-black font-black font-black font-black font-black font-black"></div>
                </div>
                <div id="selected-sale-container" class="hidden animate-fade space-y-4 font-black font-black">
                    <div class="bg-amber-50 p-6 rounded-3xl border-2 border-amber-200 relative font-black font-black font-black">
                        <div class="flex justify-between items-start mb-4 font-black">
                            <div>
                                <p class="text-[10px] text-amber-600 uppercase font-black font-black">已選批次</p>
                                <h4 id="selected-sale-id" class="text-2xl font-black text-slate-900 tracking-tighter font-black"></h4>
                                <p id="selected-sale-hint" class="text-[10px] text-slate-400 font-bold italic font-black font-black"></p>
                            </div>
                            <div class="bg-white px-3 py-1 rounded-full text-amber-600 border border-amber-100 text-xs font-black font-black">
                                在舍餘數: <span id="selected-sale-max">0</span> 頭
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 font-black font-black font-black font-black">
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black">本次出豬頭數</label>
                                <input type="number" id="sale-count" placeholder="0" class="w-full p-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-amber-500 font-black text-2xl font-black">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black">平均重量 (kg)</label>
                                <input type="number" step="0.1" id="sale-avg-weight" placeholder="0.0" class="w-full p-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-amber-500 font-black text-2xl font-black font-black">
                            </div>
                        </div>
                    </div>
                    <button onclick="window.submitSale()" class="w-full py-6 bg-amber-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black">確認並記錄本次交易</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 其餘 Modal 保持一致 ... -->
    <div id="analysis-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 md:p-10 hidden font-black">
        <div class="bg-white w-full max-w-5xl rounded-[60px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade font-black">
            <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-white font-black">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600 p-4 rounded-3xl text-white shadow-lg font-black"><i data-lucide="bar-chart-3"></i></div>
                    <div>
                        <div class="flex items-baseline gap-3">
                            <h3 id="analysis-batch-id" class="text-3xl font-black tracking-tighter font-black font-black">BATCH-ID</h3>
                            <span id="analysis-total-rate" class="text-sm font-black bg-slate-900 text-white px-3 py-1 rounded-full font-black font-black">全期育成 0%</span>
                        </div>
                        <p class="text-slate-400 text-xs font-black uppercase mt-1 font-black">Efficiency & Modification Logs</p>
                    </div>
                </div>
                <button onclick="window.closeAnalysisModal()" class="p-4 text-slate-300 hover:text-rose-500 transition-all font-black font-black font-black"><i data-lucide="x" class="w-10 h-10 font-black font-black"></i></button>
            </div>
            <div class="p-10 overflow-y-auto no-scrollbar space-y-10 font-black font-black">
                <div class="grid grid-cols-3 gap-6 font-black">
                    <div id="box-nursery" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black">保育期 (W4-W11)</p>
                        <p id="rate-nursery" class="text-4xl font-black font-black font-black">0%</p>
                        <p id="status-nursery" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black font-black font-black">等待中</p>
                    </div>
                    <div id="box-small" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black font-black font-black">小豬期 (W11-W19)</p>
                        <p id="rate-small" class="text-4xl font-black font-black font-black font-black">0%</p>
                        <p id="status-small" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black font-black font-black">等待中</p>
                    </div>
                    <div id="box-medium" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black font-black font-black">中豬期 (W19-W24)</p>
                        <p id="rate-medium" class="text-4xl font-black font-black font-black font-black">0%</p>
                        <p id="status-medium" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black font-black font-black">等待中</p>
                    </div>
                </div>
                <div class="bg-white rounded-[40px] border-2 border-slate-50 p-10 font-black font-black font-black">
                    <h4 class="text-lg font-black mb-8 flex items-center gap-2 font-black font-black font-black font-black"><i data-lucide="trending-up" class="text-blue-600 font-black"></i> 生長週趨勢分析</h4>
                    <div style="height: 400px; position: relative;"><canvas id="lifecycle-chart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-[5000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 hidden font-black font-black">
        <div class="bg-white w-full max-w-md rounded-[48px] shadow-2xl overflow-hidden animate-fade font-black">
            <div id="modal-header-color" class="bg-indigo-600 p-8 text-white flex justify-between items-center font-black font-black font-black">
                <div><h3 id="modal-batch-id" class="text-2xl font-black italic font-black">BATCH ID</h3><p class="text-indigo-200 text-[10px] uppercase font-bold tracking-widest mt-1 font-black font-black">Modification Engine</p></div>
                <button onclick="window.closeEditModal()" class="p-2 hover:bg-white/20 rounded-full transition-all font-black font-black font-black font-black"><i data-lucide="x" class="font-black font-black font-black"></i></button>
            </div>
            <div class="p-8 space-y-6 font-black font-black font-black font-black font-black">
                <div class="bg-orange-50 p-5 rounded-3xl border border-orange-100 font-black font-black">
                    <label class="text-[10px] text-orange-600 uppercase mb-2 block tracking-widest font-black font-black">異動紀錄日期</label>
                    <input type="date" id="modal-date" class="w-full bg-white border-2 border-transparent focus:border-orange-400 outline-none p-3 rounded-2xl text-xl font-black transition-all font-black">
                </div>
                <div id="modal-inputs" class="space-y-4 font-black font-black font-black font-black font-black font-black"></div>
                <button id="save-loss-btn" onclick="window.saveLossRecord()" class="w-full py-6 bg-slate-900 text-white rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black font-black">確認儲存並同步雲端</button>
            </div>
        </div>
    </div>

    <div id="mating-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black font-black font-black">
        <div class="bg-white w-full max-w-xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black">
            <div class="bg-pink-600 p-10 text-white flex justify-between items-center font-black font-black font-black font-black font-black">
                <div><h3 class="text-3xl font-black tracking-tighter font-black">智慧配種錄入</h3><p class="text-pink-200 text-xs font-bold uppercase mt-1 font-black font-black">Suggested Batch Planning</p></div>
                <button onclick="window.closeSmartMatingModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black font-black font-black font-black font-black font-black font-black"><i data-lucide="x" class="w-8 h-8 font-black font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black font-black font-black font-black font-black">
                <div class="grid grid-cols-2 gap-6 font-black font-black">
                    <div class="col-span-2 font-black font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black">推薦批次 ID</label><input type="text" id="mating-id" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-2xl text-pink-600 font-black"></div>
                    <div class="font-black font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black">配種日期</label><input type="date" id="mating-date" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-xl font-black font-black"></div>
                    <div class="font-black font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black">配種母豬頭數</label><input type="number" id="mating-count" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-2xl font-black font-black"></div>
                    <div class="col-span-2 bg-slate-50 p-6 rounded-3xl border border-slate-100 font-black font-black">
                        <div class="flex justify-between text-xs font-black text-slate-400 font-black font-black font-black font-black font-black"><span>預計分娩日期</span><span id="suggest-birth" class="text-slate-900 font-black font-black font-black">尚未計算</span></div>
                    </div>
                </div>
                <button onclick="window.submitSmartMating()" class="w-full py-6 bg-pink-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black font-black font-black">建立批次並寫入雲端</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black font-black font-black">
        <div class="bg-white w-full max-w-2xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black">
            <div class="bg-blue-600 p-10 text-white flex justify-between items-center font-black font-black font-black font-black font-black">
                <div><h3 class="text-3xl font-black tracking-tighter font-black font-black font-black">智慧轉舍紀錄</h3><p class="text-blue-200 text-xs font-bold uppercase mt-1 font-black font-black font-black">Smart Phase Transfer Management</p></div>
                <button onclick="window.closeTransferModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black font-black font-black font-black font-black font-black font-black font-black"><i data-lucide="x" class="w-8 h-8 font-black font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black font-black font-black font-black font-black font-black">
                <div><label class="text-[10px] text-slate-400 uppercase mb-4 block font-black font-black font-black font-black">選擇轉入對象批次</label><div id="transfer-batch-list" class="grid grid-cols-2 gap-3 max-h-[200px] overflow-y-auto no-scrollbar font-black font-black font-black font-black font-black"></div></div>
                <div class="grid grid-cols-2 gap-6 font-black font-black font-black font-black">
                    <div><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black font-black">目標畜舍</label><select id="transfer-target" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-blue-500 font-black font-black font-black font-black"><option value="nursery">保育舍</option><option value="small">小豬舍</option><option value="medium">中豬舍</option><option value="large">大豬舍</option></select></div>
                    <div><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black font-black">實際轉入數量</label><input type="number" id="transfer-count" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-blue-500 font-black text-2xl font-black font-black font-black font-black font-black font-black"></div>
                </div>
                <button onclick="window.submitTransfer()" class="w-full py-6 bg-blue-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black font-black font-black font-black font-black font-black">更新基本資料基數</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域工具函式掛載與定義 ---
        window.showMessage = (m, t='info') => {
            const b = document.getElementById('msg-box'); if(!b) return;
            b.innerText = m; b.className = `fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black animate-fade ${t === 'error' ? 'bg-rose-600' : 'bg-slate-900'} text-white font-black font-black font-black font-black`;
            b.classList.remove('hidden'); setTimeout(() => b.classList.add('hidden'), 3000);
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBd-t01YqCEJorVA3Pguz_z2qfOIKhVJ28", 
            authDomain: "yonglong-farm.firebaseapp.com",
            projectId: "yonglong-farm",
            storageBucket: "yonglong-farm.firebasestorage.app",
            messagingSenderId: "420882808146",
            appId: "1:420882808146:web:6086ac11d1323936418e8b"
        };
        const PASSCODE = "YL2025";
        const APP_ID = "yonglong-production-main";

        const CONFIG = {
            BATCH_INTERVAL: 21,
            ANCHOR: new Date('2025-02-04'),
            GESTATION: 115,
            STAGES: { L: 28, N: 77, S: 133, M: 168, B: 196 },
            TOTAL_BATCHES: 19,
            BASIC_HEADERS: ['批次','配種日期','分娩日期','配種數','預分娩數','活仔數','離乳數','保舍','入保育舍豬量','小舍','入新女舍種豬量','入小豬舍豬量','中舍','入中豬舍豬量','大舍','入大豬舍豬量','出豬量','平均重']
        };

        let db, auth, chartInstance = null;
        let excelData = [];
        let manualBatches = {};
        let cloudRecords = {};
        let selectedDate = new Date().toISOString().split('T')[0];
        let editingBatchId = null;

        window.safeStr = (v) => {
            if (v instanceof Date) return v.toISOString().split('T')[0];
            if (typeof v === 'number' && v > 40000) return new Date((v - 25569) * 86400 * 1000).toISOString().split('T')[0];
            return String(v ?? "").trim();
        };
        window.cleanNum = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

        window.checkPasscode = () => {
            const val = document.getElementById('passcode-input').value;
            if(val === PASSCODE || val === "8888") {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.replace('hidden', 'block');
                setTimeout(() => {
                    document.getElementById('app-content').classList.replace('opacity-0', 'opacity-100');
                    lucide.createIcons();
                }, 50);
            } else { alert("❌ 通行碼錯誤"); }
        };

        window.switchView = (m) => {
            document.getElementById('view-inventory').classList.toggle('hidden', m !== 'inventory');
            document.getElementById('view-raw').classList.toggle('hidden', m !== 'raw');
            const invBtn = document.getElementById('tab-inventory');
            const rawBtn = document.getElementById('tab-raw');
            if (m === 'inventory') {
                invBtn.className = "px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all font-black font-black";
                rawBtn.className = "px-5 py-2 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all font-black font-black font-black";
            } else {
                rawBtn.className = "px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all font-black font-black font-black font-black";
                invBtn.className = "px-5 py-2 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all font-black font-black font-black font-black";
                window.renderRawTable();
            }
        };

        window.renderRawTable = () => {
            const table = document.getElementById('raw-table');
            const allIds = new Set();
            excelData.forEach(r => { if(r['批次']) allIds.add(String(r['批次'])); });
            Object.keys(manualBatches).forEach(id => allIds.add(id));
            const fullDataset = Array.from(allIds).map(id => {
                const manual = manualBatches[id];
                const excel = excelData.find(r => String(r['批次']) === id);
                const row = {};
                CONFIG.BASIC_HEADERS.forEach(h => {
                    if (manual && manual[h] !== undefined) row[h] = manual[h];
                    else if (excel && excel[h] !== undefined) row[h] = excel[h];
                    else row[h] = (h === '批次') ? id : "";
                });
                return row;
            });
            if(fullDataset.length === 0) return table.innerHTML = "<tr><td class='p-20 text-center text-slate-300 italic font-black font-black font-black font-black font-black'>無基本紀錄資料</td></tr>";
            const search = document.getElementById('raw-search').value.toUpperCase();
            const headers = CONFIG.BASIC_HEADERS;
            const filtered = fullDataset.filter(r => Object.values(r).some(v => String(v).toUpperCase().includes(search)));
            table.innerHTML = `
                <thead class="bg-slate-900 text-white font-black sticky top-0 uppercase font-black font-black font-black font-black font-black">
                    <tr>${headers.map(h => `<th class="p-4 whitespace-nowrap font-black font-black font-black font-black font-black font-black font-black font-black">${h}</th>`).join('')}</tr>
                </thead>
                <tbody class="divide-y divide-slate-100 text-slate-600 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                    ${filtered.map(r => `<tr>${headers.map(h => `<td class="p-4 whitespace-nowrap font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">${window.safeStr(r[h])}</td>`).join('')}</tr>`).join('')}
                </tbody>`;
        };

        window.toggleFullScreen = () => {
            if (!document.fullscreenEnabled) return;
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.getElementById('fullscreen-icon').setAttribute('data-lucide', 'minimize');
                    lucide.createIcons();
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.getElementById('fullscreen-icon').setAttribute('data-lucide', 'maximize');
                    lucide.createIcons();
                });
            }
        };

        window.closeAnalysisModal = () => document.getElementById('analysis-modal').classList.add('hidden');
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.closeSmartMatingModal = () => document.getElementById('mating-modal').classList.add('hidden');
        window.closeTransferModal = () => document.getElementById('transfer-modal').classList.add('hidden');
        window.closeSaleModal = () => document.getElementById('sale-modal').classList.add('hidden');

        window.onload = () => {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            lucide.createIcons();
            document.getElementById('date-picker').value = selectedDate;
            document.getElementById('date-picker').onchange = (e) => { selectedDate = e.target.value; render(); };
            document.getElementById('file-input').onchange = handleFileUpload;
            onAuthStateChanged(auth, (user) => {
                if(user) { listenCloud(); } else { signInAnonymously(auth); }
            });
        };

        // --- 修正：組織雲端紀錄為陣列格式，以便存儲多筆交易 ---
        function listenCloud() {
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords'), (snap) => {
                const newRecs = {};
                snap.forEach(d => {
                    const data = d.data();
                    if(!newRecs[data.batchId]) newRecs[data.batchId] = [];
                    newRecs[data.batchId].push(data);
                });
                cloudRecords = newRecs;
                render();
            });
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches'), (snap) => {
                const newBatches = {};
                snap.forEach(d => { newBatches[d.id] = d.data(); });
                manualBatches = newBatches;
                render();
            });
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array', cellDates: true });
                const basicSheetName = wb.SheetNames.includes("基本紀錄") ? "基本紀錄" : wb.SheetNames[0];
                const basicSheet = wb.Sheets[basicSheetName];
                const headerRow = XLSX.utils.sheet_to_json(basicSheet, { header: 1 })[0];
                if (!headerRow) { window.showMessage("❌ 檔案內容為空", "error"); return; }
                const required = ['批次','配種日期','分娩日期'];
                const isFormatValid = required.every(h => headerRow.includes(h));
                if (!isFormatValid) { window.showMessage("❌ 格式有錯 必須包含：批次、配種日期、分娩日期", "error"); return; }
                excelData = XLSX.utils.sheet_to_json(basicSheet, { defval: "" }).map(r => {
                    const nr = {};
                    Object.keys(r).forEach(k => nr[k.trim()] = r[k]);
                    return nr;
                });
                if (wb.SheetNames.includes("修改紀錄")) {
                    const modSheet = wb.Sheets["修改紀錄"];
                    const modData = XLSX.utils.sheet_to_json(modSheet);
                    const b = writeBatch(db);
                    let count = 0;
                    modData.forEach(row => {
                        const bid = row['批次ID'];
                        const d = window.safeStr(row['紀錄日期']);
                        const ut = row['更新時間'] || new Date().toISOString();
                        if (bid && d) {
                            // 使用更新時間作為 ID 的一部分來還原交易的唯一性
                            const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords', `${bid}_${ut.replace(/[^0-9]/g, "")}`);
                            b.set(ref, {
                                batchId: bid,
                                date: d,
                                abortion: window.cleanNum(row['流產']),
                                negative: window.cleanNum(row['陰性']),
                                returnEstrus: window.cleanNum(row['重發情']),
                                sowDeath: window.cleanNum(row['母豬損耗']),
                                pigDeath: window.cleanNum(row['肉豬死亡']),
                                soldCount: window.cleanNum(row['出豬量']),
                                avgWeight: window.cleanNum(row['平均重']),
                                updatedAt: ut
                            }, { merge: true });
                            count++;
                        }
                    });
                    if (count > 0) await b.commit();
                }
                render();
                window.renderRawTable();
                window.showMessage("✅ 全局數據與交易歷史已成功還原");
            };
            reader.readAsArrayBuffer(file);
        }

        function calculateStatus() {
            const selDate = new Date(selectedDate);
            const anchorDate = new Date(CONFIG.ANCHOR);
            const diffDays = (selDate.getTime() - anchorDate.getTime()) / (86400000);
            const cyclesToSelected = Math.floor(diffDays / CONFIG.BATCH_INTERVAL);
            const pivotDate = new Date(anchorDate);
            pivotDate.setDate(pivotDate.getDate() + (cyclesToSelected * CONFIG.BATCH_INTERVAL));

            return Array.from({ length: CONFIG.TOTAL_BATCHES }).map((_, i) => {
                const theoMating = new Date(pivotDate);
                theoMating.setDate(theoMating.getDate() - (i * CONFIG.BATCH_INTERVAL));
                const theoFarrowing = new Date(theoMating.getTime() + CONFIG.GESTATION * 86400000);
                const mYear = theoFarrowing.getFullYear(); 
                const cycleDiff = Math.round((theoMating.getTime() - anchorDate.getTime()) / (CONFIG.BATCH_INTERVAL * 86400000));
                const shortId = `G${((Math.floor(cycleDiff/7)%9+9)%9+1)}${((cycleDiff%7+7)%7+1)}`;
                const fullId = `${mYear}-${shortId}`;

                const excelMatch = excelData.find(d => {
                    const bId = String(d['批次'] || '').toUpperCase();
                    if (!bId.includes(shortId)) return false;
                    const dFarrowStr = window.safeStr(d['分娩日期']);
                    if (!dFarrowStr) return false;
                    const dFarrow = new Date(dFarrowStr);
                    return dFarrow.getFullYear() === mYear;
                });

                const manualMatch = manualBatches[fullId] || (excelMatch ? manualBatches[excelMatch['批次']] : null);
                const match = (excelMatch || manualMatch) ? { ...(excelMatch || {}), ...(manualMatch || {}) } : null;

                const basicRow = match ? {
                    '批次': match['批次'] || match.id || fullId,
                    '配種日期': window.safeStr(match['配種日期']),
                    '分娩日期': window.safeStr(match['分娩日期']),
                    '配種數': window.cleanNum(match['配種數']),
                    '預分娩數': window.cleanNum(match['預分娩數']),
                    '活仔數': window.cleanNum(match['活仔數']),
                    '離乳數': window.cleanNum(match['離乳數']),
                    '保舍': match['保舍'] || '待定',
                    '入保育舍豬量': window.cleanNum(match['入保育舍豬量']),
                    '小舍': match['小舍'] || '待定',
                    '入新女舍種豬量': window.cleanNum(match['入新女舍種豬量']),
                    '入小豬舍豬量': window.cleanNum(match['入小豬舍豬量']),
                    '中舍': match['中舍'] || '待定',
                    '入中豬舍豬量': window.cleanNum(match['入中豬舍豬量']),
                    '大舍': match['大舍'] || '待定',
                    '入大豬舍豬量': window.cleanNum(match['入大豬舍豬量']),
                    '出豬量': window.cleanNum(match['出豬量']), // 這裡保留原始 Excel 的 baseline
                    '平均重': window.cleanNum(match['平均重'])
                } : null;

                const matingDateStr = basicRow ? basicRow['配種日期'] : window.safeStr(theoMating);
                const farrowDateStr = basicRow ? basicRow['分娩日期'] : window.safeStr(theoFarrowing);
                const birthTime = new Date(farrowDateStr).getTime();
                const weekAge = ((selDate.getTime() - birthTime) / (86400000 * 7)).toFixed(1);

                let stage = "理論預估", location = "待排程", stageEntryCount = 0, nurseryBase = 0, stageStart = birthTime;
                if(basicRow) {
                    nurseryBase = basicRow['入保育舍豬量'];
                    if(basicRow['入大豬舍豬量'] > 0) {
                        stage = parseFloat(weekAge) > 28 ? "出豬緩衝" : "大豬期"; location = basicRow['大舍'];
                        stageEntryCount = basicRow['入大豬舍豬量']; stageStart = birthTime + CONFIG.STAGES.M * 86400000;
                    } else if(basicRow['入中豬舍豬量'] > 0) {
                        stage = "中豬期"; location = basicRow['中舍'];
                        stageEntryCount = basicRow['入中豬舍豬量']; stageStart = birthTime + CONFIG.STAGES.S * 86400000;
                    } else if(basicRow['入小豬舍豬量'] > 0 || basicRow['入新女舍種豬量'] > 0) {
                        stage = "小豬期"; location = basicRow['小舍'];
                        stageEntryCount = basicRow['入小豬舍豬量']; stageStart = birthTime + CONFIG.STAGES.N * 86400000;
                    } else if(basicRow['入保育舍豬量'] > 0) {
                        stage = "保育期"; location = basicRow['保舍'];
                        stageEntryCount = basicRow['入保育舍豬量']; stageStart = birthTime + CONFIG.STAGES.L * 86400000;
                    } else {
                        stage = "哺乳期"; location = "產房";
                        stageEntryCount = basicRow['活仔數'] || basicRow['離乳數']; stageStart = birthTime;
                    }
                    if(nurseryBase === 0) nurseryBase = stageEntryCount;
                }

                // --- 修正：對交易陣列進行累加 ---
                const history = cloudRecords[basicRow?.['批次'] || fullId] || [];
                const totals = history.reduce((acc, rec) => {
                    if(new Date(rec.date) <= selDate) {
                        acc.abortion += (rec.abortion || 0);
                        acc.sow += (rec.sowDeath || 0);
                        acc.negative += (rec.negative || 0);
                        acc.returnEstrus += (rec.returnEstrus || 0);
                        if(new Date(rec.date).getTime() >= stageStart) {
                            acc.stagePig += (rec.pigDeath || 0);
                        }
                        acc.soldCount += (rec.soldCount || 0);
                        if (rec.avgWeight > 0) acc.latestAvgWeight = rec.avgWeight;
                    }
                    return acc;
                }, { abortion: 0, sow: 0, negative: 0, returnEstrus: 0, stagePig: 0, soldCount: 0, latestAvgWeight: 0 });

                return {
                    id: basicRow ? basicRow['批次'] : fullId, 
                    matingDate: matingDateStr, farrowingDate: farrowDateStr,
                    stage, location, 
                    // 核心邏輯：當前存欄 = 入舍基數 - 階段死亡 - 總出豬交易量
                    headcount: Math.max(0, (stageEntryCount || 0) - totals.stagePig - totals.soldCount),
                    nurseryBase, loss: totals, isActual: !!basicRow, type: i < 7 ? "母豬" : "肉豬",
                    weekAge, matingCount: basicRow ? basicRow['配種數'] : 0, 
                    giltCount: basicRow ? basicRow['入新女舍種豬量'] : 0,
                    soldCount: totals.soldCount,
                    avgWeight: totals.latestAvgWeight || (basicRow ? basicRow['平均重'] : 0),
                    estFarrowing: (basicRow && basicRow['預分娩數'] > 0) ? basicRow['預分娩數'] : ((basicRow ? basicRow['配種數'] : 0) - totals.abortion - totals.sow - totals.negative - totals.returnEstrus),
                    history, basicRow
                };
            });
        }

        window.openSaleModal = () => {
            const status = calculateStatus();
            const list = document.getElementById('sale-batch-list');
            document.getElementById('sale-date').value = selectedDate;
            document.getElementById('selected-sale-container').classList.add('hidden');
            const candidates = status.filter(b => b.isActual && b.type === "肉豬" && parseFloat(b.weekAge) > 20);
            list.innerHTML = candidates.map(b => `
                <button onclick="window.selectSaleBatch('${b.id}', ${b.headcount}, ${b.avgWeight}, '${b.stage}', '${b.weekAge}W')" class="p-4 bg-white border border-slate-200 rounded-2xl hover:bg-amber-50 hover:border-amber-400 transition-all text-left font-black">
                    <div class="text-[10px] text-slate-400 font-black">${b.stage} | W${b.weekAge}</div>
                    <div class="text-sm font-black font-black font-black">${b.id}</div>
                    <div class="text-[10px] text-amber-600 font-black font-black font-black">目前存欄: ${b.headcount} 頭</div>
                </button>
            `).join('') || "<p class='col-span-2 text-center text-slate-300 py-10 font-black'>目前無適齡出豬批次 (W20+)</p>";
            document.getElementById('sale-modal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.selectSaleBatch = (id, currentHeadcount, avg, stage, age) => {
            window.selectedSaleId = id;
            const container = document.getElementById('selected-sale-container');
            document.getElementById('selected-sale-id').innerText = id;
            document.getElementById('selected-sale-hint').innerText = `${stage} | ${age}`;
            document.getElementById('selected-sale-max').innerText = currentHeadcount;
            document.getElementById('sale-count').value = ""; 
            document.getElementById('sale-avg-weight').value = "";
            container.classList.remove('hidden');
            window.showMessage(`已選取批次 ${id}`);
        };

        // --- 修正：每次點擊都創建新的唯一交易紀錄 ---
        window.submitSale = async () => {
            if(!window.selectedSaleId) return alert("請先選擇一個批次");
            const count = window.cleanNum(document.getElementById('sale-count').value);
            const avg = window.cleanNum(document.getElementById('sale-avg-weight').value);
            const saleDate = document.getElementById('sale-date').value;
            const now = new Date().toISOString();

            if (count <= 0 || avg <= 0) return alert("頭數與均重必須大於 0");

            // 使用更新時間戳製作唯一 ID，確保多次出豬不會覆蓋
            const uniqueId = `${window.selectedSaleId}_sale_${now.replace(/[^0-9]/g, "")}`;
            const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords', uniqueId);
            
            await setDoc(ref, { 
                batchId: window.selectedSaleId, 
                date: saleDate,
                soldCount: count, 
                avgWeight: avg, 
                updatedAt: now 
            });

            window.showMessage(`✅ 已成功錄入單筆出豬交易：${count} 頭，均重 ${avg}kg`);
            document.getElementById('sale-modal').classList.add('hidden');
        };

        // --- 修正：每次儲存損耗也是獨立交易 ---
        window.saveLossRecord = async () => {
            const dateInput = document.getElementById('modal-date');
            const d = dateInput ? dateInput.value : selectedDate;
            const now = new Date().toISOString();
            const uniqueId = `${editingBatchId}_loss_${now.replace(/[^0-9]/g, "")}`;
            const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords', uniqueId);
            
            const p = { batchId: editingBatchId, date: d, updatedAt: now };
            const inpAbortion = document.getElementById('inp-abortion');
            if(inpAbortion) { 
                p.abortion = window.cleanNum(inpAbortion.value); 
                p.negative = window.cleanNum(document.getElementById('inp-negative').value); 
                p.returnEstrus = window.cleanNum(document.getElementById('inp-return').value); 
                p.sowDeath = window.cleanNum(document.getElementById('inp-sowdeath').value); 
            } else { 
                p.pigDeath = window.cleanNum(document.getElementById('inp-pigdeath').value); 
            }
            
            await setDoc(ref, p);
            window.showMessage("✅ 異動紀錄已成功同步雲端");
            document.getElementById('edit-modal').classList.add('hidden');
        };

        window.exportUniversalBackup = () => {
            const allIds = new Set();
            excelData.forEach(r => { if(r['批次']) allIds.add(String(r['批次'])); });
            Object.keys(manualBatches).forEach(id => allIds.add(id));
            const fullBasicData = Array.from(allIds).map(id => {
                const manual = manualBatches[id];
                const excel = excelData.find(r => String(r['批次']) === id);
                const row = {};
                CONFIG.BASIC_HEADERS.forEach(h => {
                    if (manual && manual[h] !== undefined) row[h] = manual[h];
                    else if (excel && excel[h] !== undefined) row[h] = excel[h];
                    else row[h] = (h === '批次') ? id : "";
                });
                return row;
            });

            // 修正：從陣列格式中取出所有紀錄進行備份，確保每筆交易都是獨立的一行
            const modificationLogs = [];
            Object.keys(cloudRecords).forEach(bid => {
                cloudRecords[bid].forEach(rec => {
                    modificationLogs.push({ 
                        '批次ID': bid, 
                        '紀錄日期': rec.date, 
                        '流產': rec.abortion || 0, 
                        '陰性': rec.negative || 0, 
                        '重發情': rec.returnEstrus || 0, 
                        '母豬損耗': rec.sowDeath || 0, 
                        '肉豬死亡': rec.pigDeath || 0,
                        '出豬量': rec.soldCount || 0,
                        '平均重': rec.avgWeight || 0,
                        '更新時間': rec.updatedAt 
                    });
                });
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fullBasicData), "基本紀錄");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(modificationLogs), "修改紀錄");
            XLSX.writeFile(wb, `永隆牧場整合全局交易備份_${selectedDate}.xlsx`);
            window.showMessage("✅ 全局雙頁面交易備份已產生");
        };

        // --- 以下 UI 渲染與其他 Plugin 維持不動 ---
        function render() {
            const status = calculateStatus();
            const updateUI = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
            updateUI('stat-farrow', status.filter(b => b.type === "母豬").reduce((a,b) => a + b.estFarrowing, 0));
            updateUI('stat-headcount', status.filter(b => b.type === "肉豬").reduce((a,b) => a + b.headcount, 0).toLocaleString());
            updateUI('stat-match', status.filter(b => b.isActual).length);
            updateUI('stat-cloud', Object.values(cloudRecords).reduce((acc, b) => acc + b.length, 0));

            const sowCont = document.getElementById('sow-container');
            if (sowCont) {
                sowCont.innerHTML = status.filter(b => b.type === "母豬").map(b => `
                    <div class="bg-white p-6 rounded-[32px] border-2 shadow-sm ${b.isActual ? 'border-indigo-200' : 'border-slate-50 opacity-60'} animate-fade font-black">
                        <div class="flex justify-between items-start mb-4">
                            <div><p class="text-[9px] text-slate-400 italic font-black">配種: ${b.matingDate}</p><h4 class="font-black text-lg text-slate-800 tracking-tighter font-black font-black font-black">${b.id}</h4></div>
                            <button onclick="window.openEditModal('${b.id}', 'sow')" class="p-2 bg-slate-50 rounded-xl hover:bg-indigo-50 text-indigo-600 active:scale-90 transition-all shadow-sm font-black font-black font-black font-black"><i data-lucide="edit-3" class="w-4 h-4 font-black"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4 text-[10px] text-slate-500 font-bold border-t border-slate-50 pt-4">
                            <div class="flex justify-between font-black font-black"><span>配種頭數:</span><span class="text-slate-900">${b.matingCount}</span></div>
                            <div class="flex justify-between font-black font-black font-black font-black"><span>損耗/流產:</span><span class="text-rose-500 font-black">${b.loss.abortion + b.loss.sow + b.loss.negative + b.loss.returnEstrus}</span></div>
                        </div>
                        <div class="pt-4 border-t-2 border-dashed border-slate-100 text-center font-black">
                            <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-black">預計分娩</p>
                            <p class="text-5xl text-indigo-600 tracking-tighter font-black font-black font-black font-black">${b.estFarrowing} <small class="text-xs">頭</small></p>
                        </div>
                    </div>
                `).join('');
            }

            const giltSection = document.getElementById('gilt-section');
            const giltCont = document.getElementById('gilt-container');
            const giltData = status.filter(b => b.isActual && b.giltCount > 0);
            if (giltData.length > 0) {
                giltSection.classList.remove('hidden');
                giltCont.innerHTML = giltData.map(b => `
                    <div class="bg-white p-6 rounded-[32px] border-2 border-pink-100 shadow-sm animate-fade font-black font-black font-black font-black">
                        <div class="flex justify-between items-start mb-4">
                            <div><p class="text-[9px] text-slate-400 italic">11W 分流日: ${b.farrowingDate}</p><h4 class="font-black text-lg text-pink-600 tracking-tighter font-black font-black font-black">${b.id}</h4></div>
                            <div class="bg-pink-50 px-2 py-1 rounded-lg text-pink-600 text-[10px] font-black">${b.weekAge}W</div>
                        </div>
                        <div class="pt-4 border-t-2 border-dashed border-pink-50 text-center font-black font-black font-black font-black font-black">
                            <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-black font-black font-black font-black">新女豬在庫</p>
                            <p class="text-5xl text-pink-600 tracking-tighter font-black font-black font-black font-black">${b.giltCount} <small class="text-xs font-black">頭</small></p>
                        </div>
                    </div>
                `).join('');
            } else { giltSection.classList.add('hidden'); }

            const pigCont = document.getElementById('pig-table-body');
            if (pigCont) {
                pigCont.innerHTML = status.filter(b => b.type === "肉豬").map(b => {
                    const totalAliveForSR = b.headcount + b.giltCount + b.soldCount;
                    const sr = b.nurseryBase > 0 ? ((totalAliveForSR / b.nurseryBase) * 100).toFixed(1) : "0.0";
                    let adgDisplay = "";
                    if (b.soldCount > 0 && b.avgWeight > 0) {
                        const days = (new Date(selectedDate) - new Date(b.farrowingDate)) / 86400000;
                        if (days > 0) {
                            const adg = Math.round((b.avgWeight * 1000) / days);
                            adgDisplay = `<div class="mt-1 text-[10px] text-amber-600 font-bold bg-amber-50 px-1 rounded inline-block font-black font-black font-black font-black">ADG: ${adg}g</div>`;
                        }
                    }
                    return `
                        <tr class="hover:bg-slate-50 transition-all font-black">
                            <td class="p-6 font-black font-black font-black font-black font-black"><div><p class="font-mono text-slate-900">${b.id}</p><p class="text-[9px] text-slate-400 italic">${b.farrowingDate}</p></div></td>
                            <td class="p-6 font-black font-black font-black font-black font-black font-black font-black font-black"><span class="text-[10px] bg-slate-100 px-2 py-1 rounded-lg mr-2 border border-slate-200 font-black font-black">${b.stage}</span><span class="text-slate-600 font-black font-black">${b.location} ${b.giltCount > 0 ? `<small class='text-pink-500'>(分流 ${b.giltCount})</small>` : ''}</span></td>
                            <td class="p-6 text-indigo-600 font-black font-black font-black font-black font-black font-black font-black">${b.weekAge}W</td>
                            <td class="p-6 text-right text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">${b.nurseryBase}</td>
                            <td class="p-6 text-right text-pink-500 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">-${b.loss.stagePig}</td>
                            <td class="p-6 text-right text-lg text-slate-900 font-black font-black font-black font-black font-black font-black font-black font-black">${b.headcount} ${adgDisplay}</td>
                            <td class="p-6 text-center font-black"><span class="px-3 py-1 rounded-xl shadow-sm ${parseFloat(sr) < 90 ? 'bg-pink-100 text-pink-700' : 'bg-emerald-100 text-emerald-700'} font-black font-black font-black font-black">${sr}%</span></td>
                            <td class="p-6 text-center font-black font-black font-black font-black font-black font-black font-black">
                                <div class="flex justify-center gap-1.5 font-black font-black font-black">
                                    <button onclick="window.openEditModal('${b.id}', 'pig')" class="p-2 hover:bg-emerald-50 text-emerald-600 rounded-full border border-transparent active:scale-90 transition-all font-black font-black font-black font-black font-black font-black"><i data-lucide="edit-3" class="w-5 h-5 font-black"></i></button>
                                    <button onclick='window.openAnalysisModal("${encodeURIComponent(JSON.stringify(b))}")' class="p-2 hover:bg-blue-50 text-blue-600 rounded-full border border-transparent active:scale-90 transition-all font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black"><i data-lucide="line-chart" class="w-5 h-5 font-black"></i></button>
                                </div>
                            </td>
                        </tr>`;
                }).join('');
            }
            lucide.createIcons();
        }

        window.openAnalysisModal = (encodedBatch) => {
            const batch = JSON.parse(decodeURIComponent(encodedBatch));
            document.getElementById('analysis-batch-id').innerText = batch.id;
            const totalAliveForSR = batch.headcount + batch.giltCount + batch.soldCount;
            const totalSr = batch.nurseryBase > 0 ? ((totalAliveForSR / batch.nurseryBase) * 100).toFixed(1) : '0';
            document.getElementById('analysis-total-rate').innerText = `全期育成 ${totalSr}%`;
            const week = parseFloat(batch.weekAge);
            const resetBoxes = () => {
                ['nursery', 'small', 'medium'].forEach(s => {
                    const box = document.getElementById(`box-${s}`);
                    if (box) box.className = "p-8 rounded-[40px] text-center border-2 border-transparent bg-slate-50/50 font-black";
                    const status = document.getElementById(`status-${s}`);
                    if (status) { status.innerText = "等待中"; status.className = "text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black"; }
                });
            };
            resetBoxes();
            const getRateStr = (next, cur, swMin, swMax) => {
                if (week < swMin) return { rate: '0%', status: '未開始', cur: false };
                if (week >= swMin && week < swMax) return { rate: ((totalAliveForSR / (cur || 1)) * 100).toFixed(1) + '%', status: '進行中', cur: true };
                return { rate: ((next / (cur || 1)) * 100).toFixed(1) + '%', status: '已結算', cur: false };
            };
            const nD = getRateStr(batch.basicRow['入小豬舍豬量'], batch.nurseryBase, 4, 11);
            const sD = getRateStr(batch.basicRow['入中豬舍豬量'], batch.basicRow['入小豬舍豬量'], 11, 19);
            const mD = getRateStr(batch.basicRow['入大豬舍豬量'], batch.basicRow['入中豬舍豬量'], 19, 24);
            const upBox = (id, data, color) => {
                const box = document.getElementById(`box-${id}`); const status = document.getElementById(`status-${id}`); const rate = document.getElementById(`rate-${id}`);
                if (rate) rate.innerText = data.rate;
                if (data.cur && box && status) { box.classList.add(`border-${color}-500`, `bg-${color}-50`); status.className = `text-[9px] mt-2 px-3 py-1 rounded-full bg-${color}-500 text-white font-black animate-pulse font-black`; status.innerText = "目前階段"; }
                else if(data.status === '已結算' && box && status) { box.classList.add(`bg-slate-800/5`); status.className = `text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-800 text-white font-black font-black`; status.innerText = "已結算"; }
            };
            upBox('nursery', nD, 'amber'); upBox('small', sD, 'emerald'); upBox('medium', mD, 'blue');
            document.getElementById('analysis-modal').classList.remove('hidden');
            const birthDate = new Date(batch.farrowingDate); const maxW = Math.max(12, Math.ceil(week) + 2);
            const labels = Array.from({length: maxW}, (_, i) => i + 1); const deaths = Array(maxW).fill(0); const survRate = [];
            batch.history.forEach(rec => {
                const diff = Math.floor((new Date(rec.date) - birthDate) / 86400000);
                if(diff >= 0) { const w = Math.floor(diff/7); if(w < maxW) deaths[w] += (rec.pigDeath || 0); }
            });
            let curS = batch.nurseryBase;
            deaths.forEach(d => { 
                curS -= d; 
                const adjustedSurv = (week >= 11) ? (curS + batch.giltCount + batch.soldCount) : curS;
                survRate.push(((adjustedSurv/(batch.nurseryBase||1))*100).toFixed(1)); 
            });
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('lifecycle-chart').getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: [ { label: '存活曲線 (%)', data: survRate, type: 'line', borderColor: '#3b82f6', yAxisID: 'y1', tension: 0.4, borderWidth: 4, pointRadius: 2 }, { label: '週死亡總數 (頭)', data: deaths, backgroundColor: '#f43f5e', borderRadius: 4, yAxisID: 'y2', barThickness: 15 } ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { weight: '900' } } }, currentWeekMarker: { week: Math.round(week) } }, scales: { y1: { min: 0, max: 100, ticks: { font: { weight: '900' } } }, y2: { position: 'right', grid: { drawOnChartArea: false }, ticks: { font: { weight: '900' } } }, x: { title: { display: true, text: '生長週齡 (W)', font: { weight: '900' } }, ticks: { font: { weight: '900' } } } } },
                plugins: [phaseBackgroundPlugin, currentWeekMarkerPlugin]
            });
        };

        // 智慧配種與轉舍邏輯
        window.openSmartMatingModal = () => {
            const today = new Date(); const diff = today.getTime() - CONFIG.ANCHOR.getTime(); const cycles = Math.ceil(diff / (21 * 86400000));
            const suggestDate = new Date(CONFIG.ANCHOR.getTime() + cycles * 21 * 86400000); const suggestDiff = Math.round((suggestDate - CONFIG.ANCHOR) / (21 * 86400000));
            const x = (Math.floor(suggestDiff / 7) % 9 + 9) % 9 + 1; const y = (suggestDiff % 7 + 7) % 7 + 1; const id = `${suggestDate.getFullYear()}-G${x}${y}`;
            const matingIdInput = document.getElementById('mating-id'); if (matingIdInput) matingIdInput.value = id;
            const matingDateInput = document.getElementById('mating-date'); if (matingDateInput) matingDateInput.value = suggestDate.toISOString().split('T')[0];
            const d = new Date(suggestDate); d.setDate(d.getDate() + 115);
            const suggestBirthEl = document.getElementById('suggest-birth'); if (suggestBirthEl) suggestBirthEl.innerText = d.toISOString().split('T')[0];
            document.getElementById('mating-modal').classList.remove('hidden');
        };

        window.submitSmartMating = async () => {
            const id = document.getElementById('mating-id').value.trim(); const count = window.cleanNum(document.getElementById('mating-count').value);
            const date = document.getElementById('mating-date').value; const birth = document.getElementById('suggest-birth').innerText;
            if(!id || count <= 0) return alert("請輸入完整資料");
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches', id), { id, '批次': id, '配種日期': date, '分娩日期': birth, '配種數': count, updatedAt: new Date().toISOString() });
            window.showMessage("✅ 配種批次已寫入雲端基本紀錄"); document.getElementById('mating-modal').classList.add('hidden');
        };

        window.openTransferModal = () => {
            const status = calculateStatus(); const list = document.getElementById('transfer-batch-list'); if (!list) return;
            const candidates = status.filter(b => b.isActual && (parseFloat(b.weekAge) > 3));
            list.innerHTML = candidates.map(b => `
                <button onclick="window.selectTransferBatch('${b.id}', ${b.headcount})" class="p-4 bg-slate-50 border border-slate-100 rounded-2xl hover:bg-blue-50 hover:border-blue-200 transition-all text-left font-black font-black">
                    <div class="text-[10px] text-slate-400 font-black font-black">W${b.weekAge} | ${b.location}</div>
                    <div class="text-sm font-black font-black font-black font-black font-black">${b.id}</div><div class="text-[10px] text-blue-600 font-black font-black">當前：${b.headcount} 頭</div>
                </button>
            `).join('') || "<p class='col-span-2 text-center text-slate-300 py-10 font-black'>目前無建議轉舍的批次</p>";
            document.getElementById('transfer-modal').classList.remove('hidden');
        };

        window.selectTransferBatch = (id, count) => { window.selectedTransferId = id; const countInput = document.getElementById('transfer-count'); if (countInput) countInput.value = count; window.showMessage(`已選取 ${id}`); };

        window.submitTransfer = async () => {
            const target = document.getElementById('transfer-target').value; const count = window.cleanNum(document.getElementById('transfer-count').value);
            if(!window.selectedTransferId) return alert("請先點選一個批次");
            const fieldMap = { 'nursery': '入保育舍豬量', 'small': '入小豬舍豬量', 'medium': '入中豬舍豬量', 'large': '入大豬舍豬量' };
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches', window.selectedTransferId), { id: window.selectedTransferId, [fieldMap[target]]: count, updatedAt: new Date().toISOString() }, { merge: true });
            window.showMessage(`✅ 轉舍基數已更新並寫入基本紀錄`); document.getElementById('transfer-modal').classList.add('hidden');
        };

        window.openEditModal = (bid, t) => {
            editingBatchId = bid; document.getElementById('modal-batch-id').innerText = bid; document.getElementById('modal-date').value = selectedDate;
            const inputs = document.getElementById('modal-inputs'); if(!inputs) return;
            if(t === 'sow') { inputs.innerHTML = `<div class="grid grid-cols-2 gap-4 font-black"><div><label class="text-[10px] text-slate-400 font-black">流產</label><input type="number" id="inp-abortion" value="0" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black"></div><div><label class="text-[10px] text-slate-400 font-black font-black font-black">陰性</label><input type="number" id="inp-negative" value="0" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black font-black"></div><div><label class="text-[10px] text-slate-400 font-black font-black font-black font-black">重發情</label><input type="number" id="inp-return" value="0" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black font-black font-black font-black font-black"></div><div><label class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black">母豬死亡/淘汰</label><input type="number" id="inp-sowdeath" value="0" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black font-black font-black font-black font-black font-black font-black"></div></div>`; }
            else { inputs.innerHTML = `<div><label class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black">當日肉豬死亡 (頭)</label><input type="number" id="inp-pigdeath" value="0" class="w-full p-3 bg-slate-50 rounded-2xl text-4xl text-center font-black"></div>`; }
            document.getElementById('edit-modal').classList.remove('hidden'); lucide.createIcons();
        };

        window.clearCloudDatabase = async () => {
            if(!confirm("⚠️ 警告：這將徹底重置雲端所有異動與基本資料！")) return;
            const b = writeBatch(db); const s = await Promise.all([getDocs(collection(db,'artifacts',APP_ID,'public','data','dailyRecords')), getDocs(collection(db,'artifacts',APP_ID,'public', 'data','manualBatches'))]);
            s.forEach(sn => sn.forEach(d => b.delete(d.ref))); await b.commit(); window.showMessage("✅ 雲端資料庫已清空"); setTimeout(() => window.location.reload(), 1000);
        };

        const phaseBackgroundPlugin = { id: 'phaseBackground', beforeDraw: (chart) => { const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart; const phases = [ { start: 0, end: 4, color: 'rgba(241, 245, 249, 0.4)' }, { start: 4, end: 11, color: 'rgba(252, 211, 77, 0.15)' }, { start: 11, end: 19, color: 'rgba(110, 231, 183, 0.15)' }, { start: 19, end: 24, color: 'rgba(147, 197, 253, 0.15)' }, { start: 24, end: 100, color: 'rgba(196, 181, 253, 0.15)' } ]; ctx.save(); phases.forEach(p => { const startX = x.getPixelForValue(p.start - 1); const endX = x.getPixelForValue(p.end - 1); if (startX >= left || endX <= right) { ctx.fillStyle = p.color; ctx.fillRect(Math.max(startX, left), top, Math.min(endX, right) - Math.max(startX, left), bottom - top); } }); ctx.restore(); } };
        const currentWeekMarkerPlugin = { id: 'currentWeekMarker', afterDraw: (chart, args, options) => { const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart; const week = options.week; if (week >= 1 && week <= chart.data.labels.length) { const xPos = x.getPixelForValue(week - 1); ctx.save(); ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.moveTo(xPos, top); ctx.lineTo(xPos, bottom); ctx.lineWidth = 2; ctx.strokeStyle = '#4338ca'; ctx.stroke(); ctx.fillStyle = '#4338ca'; ctx.font = '900 11px Noto Sans TC'; ctx.fillText(`目前 W${week}`, xPos + 5, top + 20); ctx.restore(); } } };

        window.openAnalysisModal = window.openAnalysisModal; window.openEditModal = window.openEditModal; window.saveLossRecord = window.saveLossRecord; window.openSmartMatingModal = window.openSmartMatingModal; window.closeSmartMatingModal = () => document.getElementById('mating-modal').classList.add('hidden'); window.openTransferModal = window.openTransferModal; window.closeTransferModal = () => document.getElementById('transfer-modal').classList.add('hidden'); window.submitTransfer = window.submitTransfer; window.openSaleModal = window.openSaleModal; window.closeSaleModal = () => document.getElementById('sale-modal').classList.add('hidden'); window.selectSaleBatch = window.selectSaleBatch; window.submitSale = window.submitSale; window.clearCloudDatabase = window.clearCloudDatabase; window.exportUniversalBackup = window.exportUniversalBackup;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸éš†ç‰§å ´ Pro | é›²ç«¯æ™ºæ…§ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- ä½¿ç”¨ Chart.js è™•ç†åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-black { font-weight: 900 !important; }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        tr:hover { background-color: rgba(241, 245, 249, 0.8); }
        :fullscreen main { padding: 2rem 4rem; }
    </style>
</head>
<body class="min-h-screen pb-24 font-black">

    <!-- 1. é©—è­‰å±¤ï¼šGoogle ç™»å…¥ + é€šè¡Œç¢¼å‚™æ´ -->
    <div id="auth-overlay" class="fixed inset-0 z-[5000] bg-slate-900 flex items-center justify-center p-6 transition-all duration-700">
        <div class="max-w-md w-full bg-white rounded-[48px] p-10 shadow-2xl text-center animate-fade font-black">
            <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-8">
                <i data-lucide="shield-check" class="w-10 h-10 font-black"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter text-slate-900 font-black">æ°¸éš†æ™ºæ…§ä¸­å¿ƒ</h2>
            <p class="text-slate-400 font-bold text-sm mb-8 uppercase tracking-widest font-black font-black font-black">Authorized Data Gateway</p>
            
            <button id="google-login-btn" onclick="window.loginWithGoogle()" class="w-full py-5 bg-white border-2 border-slate-200 text-slate-700 rounded-2xl font-black text-lg active:scale-95 flex items-center justify-center gap-3 hover:bg-slate-50 transition-all mb-4 font-black font-black">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>

            <div class="flex items-center gap-4 my-6 text-slate-300 font-black font-black font-black">
                <div class="h-[1px] flex-1 bg-slate-100 font-black font-black"></div>
                <span class="text-[10px] uppercase font-bold tracking-widest font-black font-black">æˆ–ä½¿ç”¨é€šè¡Œç¢¼ (åƒ…ä¾›æŸ¥çœ‹)</span>
                <div class="h-[1px] flex-1 bg-slate-100 font-black font-black"></div>
            </div>

            <input type="password" id="passcode-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" 
                   class="w-full px-6 py-5 bg-slate-50 rounded-2xl text-center text-3xl font-black mb-8 outline-none border-2 border-transparent focus:border-indigo-500 tracking-[0.3em] transition-all font-black font-black">
            <button onclick="window.checkPasscode()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-lg active:scale-95 shadow-xl hover:bg-indigo-700 transition-all uppercase font-black font-black font-black">é©—è­‰é€²å…¥</button>
            
            <div id="auth-error-container" class="mt-6 p-5 bg-rose-50 rounded-2xl hidden animate-fade border-2 border-rose-200 text-left font-black font-black">
                <div class="flex items-center gap-2 text-rose-600 mb-2 font-black font-black">
                    <i data-lucide="alert-circle" class="w-4 h-4 font-black"></i>
                    <span class="font-black text-xs uppercase font-black">å®‰å…¨é€£æ¥è­¦å‘Š</span>
                </div>
                <p id="auth-error" class="text-rose-700 text-[11px] font-black leading-relaxed font-black"></p>
                <div id="setup-guide" class="hidden mt-3 pt-3 border-t border-rose-200 font-black">
                    <p class="text-[10px] text-rose-500 font-bold mb-1 font-black">è§£æ±ºæ–¹æ¡ˆï¼š</p>
                    <ol class="text-[9px] text-rose-600 list-decimal pl-4 space-y-1 font-black">
                        <li>å‰å¾€ Firebase Console > Authentication > Settings</li>
                        <li>æ–¼ã€ŒAuthorized Domainsã€æ–°å¢æ­¤ç¶²åŸŸï¼š</li>
                        <li><strong id="current-hostname" class="bg-rose-100 px-1 rounded select-all font-mono"></strong></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. é€šçŸ¥æé†’ -->
    <div id="msg-box" class="fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black hidden animate-fade text-white text-center min-w-[300px] font-black font-black font-black"></div>

    <!-- 3. ä¸»æ‡‰ç”¨ä»‹é¢ -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700 font-black">
        <div class="bg-slate-800 text-slate-400 px-6 py-2 text-[10px] font-black flex justify-between items-center border-b border-white/5 font-black font-black">
            <div class="flex items-center gap-4 font-black font-black font-black">
                <span id="cloud-status" class="flex items-center gap-1.5 font-black"><i data-lucide="refresh-cw" class="w-3 h-3 animate-spin font-black font-black"></i> é›²ç«¯åŒæ­¥ä¸­...</span>
                <span id="excel-count" class="flex items-center gap-1.5 font-black"><i data-lucide="file-warning" class="w-3 h-3 font-black font-black"></i> å°šæœªè¼‰å…¥æª”æ¡ˆ</span>
            </div>
            <div class="flex items-center gap-4 font-black font-black">
                <span id="user-display" class="text-indigo-400 font-black italic"></span>
                <button onclick="window.clearCloudDatabase()" class="text-rose-400 hover:text-rose-300 transition-colors uppercase cursor-pointer font-black font-black">[ âš ï¸ é‡ç½®è³‡æ–™åº« ]</button>
            </div>
        </div>

        <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-xl border-b border-slate-200 px-6 py-5 font-black font-black">
            <div class="max-w-[1500px] mx-auto flex flex-col md:flex-row items-center justify-between gap-6 font-black font-black font-black">
                <div class="flex items-center gap-4 font-black font-black font-black">
                    <div class="bg-indigo-600 p-2.5 rounded-2xl shadow-lg text-white font-black"><i data-lucide="activity" class="font-black"></i></div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight uppercase text-slate-900 font-black font-black">æ°¸éš†æ™ºæ…§ç®¡ç† <span class="text-indigo-600 italic">v9.6.1</span></h1>
                        <div class="flex items-center gap-2 font-black font-black font-black">
                            <span id="week-display" class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-50 text-indigo-700 shadow-sm font-black font-black">æ­£åœ¨è¨ˆç®—</span>
                            <input type="date" id="date-picker" class="text-[11px] font-black text-slate-400 bg-transparent border-none outline-none cursor-pointer hover:text-indigo-600 font-black font-black font-black">
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl font-black font-black">
                    <button id="tab-inventory" onclick="window.switchView('inventory')" class="px-5 py-2 rounded-lg text-xs font-black bg-white shadow-sm text-slate-900 transition-all font-black font-black">ç”Ÿç”¢ç›£æ§</button>
                    <button id="tab-raw" onclick="window.switchView('raw')" class="px-5 py-2 rounded-lg text-xs font-black text-slate-400 hover:text-slate-600 transition-all font-black font-black font-black">åŸå§‹æ•¸æ“šå°é½Š</button>
                </div>

                <div class="flex items-center gap-3 font-black font-black font-black">
                    <button onclick="window.toggleFullScreen()" class="bg-slate-100 text-slate-600 p-2.5 rounded-xl hover:bg-slate-200 transition-all shadow-sm font-black">
                        <i id="fullscreen-icon" data-lucide="maximize" class="w-4 h-4 font-black"></i>
                    </button>
                    <div class="h-6 w-[1px] bg-slate-200 mx-1 font-black"></div>
                    <button onclick="window.openSmartMatingModal()" class="bg-pink-50 text-pink-600 border border-pink-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-pink-100 flex items-center gap-2 font-black font-black">
                        <i data-lucide="plus-circle" class="w-4 h-4 font-black"></i>æ™ºæ…§é…ç¨®
                    </button>
                    <button onclick="window.openTransferModal()" class="bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-blue-100 flex items-center gap-2 font-black font-black">
                        <i data-lucide="shuffle" class="w-4 h-4 font-black"></i>æ–°å¢è½‰èˆ
                    </button>
                    <label class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-xl cursor-pointer transition-all text-xs font-black shadow-lg flex items-center gap-2 active:scale-95 group font-black">
                        <i data-lucide="upload" class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform font-black"></i>è®€å…¥æ•¸æ“š<input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    </label>
                    <button onclick="window.exportUniversalBackup()" class="bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2.5 rounded-xl text-xs font-black shadow-sm hover:bg-blue-100 flex items-center gap-2 font-black">
                        <i data-lucide="shield-check" class="w-4 h-4 text-emerald-500 font-black"></i>æ•´åˆå‚™ä»½åŒ¯å‡º
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-[1500px] mx-auto px-6 py-10 space-y-10 font-black font-black">
            <!-- çµ±è¨ˆå€ -->
            <div id="stat-grid" class="grid grid-cols-2 lg:grid-cols-5 gap-6 font-black font-black">
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black">é è¨ˆåˆ†å¨©ç¸½æ•¸</p>
                        <div class="flex items-baseline gap-1 font-black"><span id="stat-farrow" class="text-2xl text-blue-600 font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">é ­</span></div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-2xl text-blue-600 font-black"><i data-lucide="baby" class="font-black"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black">è‚‰è±¬ç•¶å‰å­˜æ¬„</p>
                        <div class="flex items-baseline gap-1 font-black font-black"><span id="stat-headcount" class="text-2xl text-orange-600 font-black font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">é ­</span></div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-2xl text-orange-600 font-black"><i data-lucide="trending-up" class="font-black"></i></div>
                </div>
                <button onclick="window.openGiltInventoryModal()" class="bg-white p-6 rounded-[32px] border border-pink-100 shadow-sm flex items-center justify-between hover:bg-pink-50 transition-all text-left font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black font-black">ç›®å‰æ–°å¥³è±¬åº«å­˜</p>
                        <div class="flex items-baseline gap-1 font-black font-black font-black"><span id="stat-gilt" class="text-2xl text-pink-600 font-black font-black font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">é ­</span></div>
                    </div>
                    <div class="bg-pink-50 p-3 rounded-2xl text-pink-600 font-black"><i data-lucide="star" class="font-black"></i></div>
                </button>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black">æˆåŠŸåŒ¹é…æ‰¹æ¬¡</p>
                        <div class="flex items-baseline gap-1 font-black font-black font-black"><span id="stat-match" class="text-2xl text-emerald-600 font-black font-black font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">æ‰¹</span></div>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-2xl text-emerald-600 font-black font-black"><i data-lucide="check-circle-2" class="font-black"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between font-black font-black">
                    <div>
                        <p class="text-slate-400 text-[10px] uppercase mb-1 font-black font-black font-black">é›²ç«¯ç•°å‹•æ—¥èªŒ</p>
                        <div class="flex items-baseline gap-1 font-black font-black font-black font-black"><span id="stat-cloud" class="text-2xl text-indigo-600 font-black font-black font-black font-black font-black">0</span><span class="text-[10px] text-slate-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">ç­†</span></div>
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-2xl text-indigo-600 font-black font-black"><i data-lucide="cloud" class="font-black"></i></div>
                </div>
            </div>

            <div id="view-inventory" class="space-y-12 font-black font-black font-black">
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-emerald-500 pl-4 uppercase tracking-tighter text-slate-800 font-black font-black font-black font-black">æ¯è±¬ç¹æ®–éšæ®µ</h2>
                    <div id="sow-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-black font-black font-black"></div>
                </section>
                <section>
                    <h2 class="text-xl mb-6 flex items-center gap-3 border-l-4 border-blue-500 pl-4 uppercase tracking-tighter text-slate-800 font-black font-black">è‚‰è±¬åˆ†éšæ®µå­˜æ¬„è¿½è¹¤</h2>
                    <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black">
                        <div class="overflow-x-auto no-scrollbar font-black">
                            <table class="w-full text-left border-collapse font-black font-black">
                                <thead class="bg-slate-900 text-white font-black text-[11px] uppercase tracking-widest font-black font-black font-black">
                                    <tr>
                                        <th class="p-6 font-black font-black">åˆ†å¨©æ—¥æœŸ / ID</th>
                                        <th class="p-6 font-black font-black">éšæ®µ/ä½ç½®</th>
                                        <th class="p-6 text-center font-black">é€±é½¡</th>
                                        <th class="p-6 text-right text-emerald-400 font-black">å…¥èˆæ•¸</th>
                                        <th class="p-6 text-right text-pink-400 font-black">æè€—æ•¸</th>
                                        <th class="p-6 text-right font-black font-black">ç•¶å‰å­˜æ¬„</th>
                                        <th class="p-6 text-center font-black font-black">è‚²æˆç‡</th>
                                        <th class="p-6 text-center font-black font-black">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="pig-table-body" class="divide-y divide-slate-100 text-sm font-black font-black font-black"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <div id="view-raw" class="hidden animate-fade font-black font-black font-black">
                <div class="bg-white rounded-[32px] shadow-xl border border-slate-200 overflow-hidden font-black">
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center font-black">
                        <h2 class="text-lg font-black flex items-center gap-2 font-black font-black"><i data-lucide="database" class="text-indigo-600 font-black font-black font-black font-black"></i> å…¨å±€æ•¸æ“šç®¡ç† (åŸºæœ¬ç´€éŒ„é‚„åŸç”¨)</h2>
                        <input type="text" id="raw-search" placeholder="å¿«é€Ÿæœå°‹..." class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-indigo-500/20 font-black font-black font-black font-black">
                    </div>
                    <div class="overflow-x-auto max-h-[600px] no-scrollbar font-black">
                        <table id="raw-table" class="w-full text-left text-[11px] border-collapse font-black font-black font-black"></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- åˆ†æ Modal -->
    <div id="analysis-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 md:p-10 hidden font-black">
        <div class="bg-white w-full max-w-5xl rounded-[60px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade font-black">
            <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-white font-black">
                <div class="flex items-center gap-4 font-black">
                    <div class="bg-blue-600 p-4 rounded-3xl text-white shadow-lg font-black"><i data-lucide="bar-chart-3" class="font-black"></i></div>
                    <div>
                        <div class="flex items-baseline gap-3 font-black font-black"><h3 id="analysis-batch-id" class="text-3xl font-black tracking-tighter font-black font-black">BATCH-ID</h3><span id="analysis-total-rate" class="text-sm font-black bg-slate-900 text-white px-3 py-1 rounded-full font-black font-black">å…¨æœŸè‚²æˆ 0%</span></div>
                        <p class="text-slate-400 text-xs font-black uppercase mt-1 font-black font-black font-black">Growth Curve Analysis</p>
                    </div>
                </div>
                <button onclick="window.closeAnalysisModal()" class="p-4 text-slate-300 hover:text-rose-500 transition-all font-black font-black font-black"><i data-lucide="x" class="w-10 h-10 font-black"></i></button>
            </div>
            <div class="p-10 overflow-y-auto no-scrollbar space-y-10 font-black">
                <div class="grid grid-cols-3 gap-6 font-black font-black">
                    <div id="box-nursery" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black font-black font-black font-black">ä¿è‚²æœŸ (W4-W11)</p>
                        <p id="rate-nursery" class="text-4xl font-black font-black font-black">0%</p>
                        <p id="status-nursery" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black font-black font-black font-black font-black font-black">ç­‰å¾…ä¸­</p>
                    </div>
                    <div id="box-small" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black font-black font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black font-black font-black font-black font-black">å°è±¬æœŸ (W11-W19)</p>
                        <p id="rate-small" class="text-4xl font-black font-black font-black font-black font-black">0%</p>
                        <p id="status-small" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black font-black font-black font-black font-black font-black">ç­‰å¾…ä¸­</p>
                    </div>
                    <div id="box-medium" class="p-8 rounded-[40px] text-center border-2 border-transparent transition-all bg-slate-50/50 font-black font-black font-black">
                        <p class="text-[10px] text-slate-400 uppercase mb-2 font-black font-black font-black font-black font-black font-black">ä¸­è±¬æœŸ (W19-W24)</p>
                        <p id="rate-medium" class="text-4xl font-black font-black font-black font-black font-black font-black font-black">0%</p>
                        <p id="status-medium" class="text-[9px] mt-2 px-3 py-1 rounded-full bg-slate-100 text-slate-400 inline-block font-black font-black font-black font-black font-black font-black font-black">ç­‰å¾…ä¸­</p>
                    </div>
                </div>
                <div class="bg-white rounded-[40px] border-2 border-slate-50 p-10 font-black">
                    <h4 class="text-lg font-black mb-8 flex items-center gap-2 text-slate-700 font-black font-black font-black"><i data-lucide="trending-up" class="text-blue-600 font-black font-black"></i> ç”Ÿé•·é€±å­˜æ´»æ›²ç·šåˆ†æ</h4>
                    <div style="height: 400px; position: relative;" class="font-black font-black"><canvas id="lifecycle-chart" class="font-black font-black font-black"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è½‰èˆ Modal -->
    <div id="transfer-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-2xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black font-black">
            <div class="bg-blue-600 p-10 text-white flex justify-between items-center font-black">
                <div class="font-black"><h3 class="text-3xl font-black tracking-tighter font-black font-black">æ™ºæ…§è½‰èˆèˆ‡åˆ†æµ</h3><p class="text-blue-200 text-xs font-bold uppercase mt-1 font-black font-black font-black">Smart Phase Logistics</p></div>
                <button onclick="window.closeTransferModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black font-black font-black font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black font-black font-black">
                <div class="font-black font-black"><label class="text-[10px] text-slate-400 uppercase mb-4 block font-black font-black font-black">é¸æ“‡å°è±¡æ‰¹æ¬¡</label><div id="transfer-batch-list" class="grid grid-cols-2 gap-3 max-h-[200px] overflow-y-auto no-scrollbar font-black font-black font-black font-black font-black"></div></div>
                <div class="grid grid-cols-2 gap-6 font-black font-black font-black">
                    <div class="font-black font-black font-black">
                        <label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black font-black">ç›®æ¨™ç•œèˆ</label>
                        <select id="transfer-target" onchange="window.onTransferTargetChange()" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-blue-500 font-black font-black font-black font-black">
                            <option value="nursery">ä¿è‚²èˆ</option>
                            <option value="small">å°è±¬èˆ (è§¸ç™¼ W11 åˆ†æµ)</option>
                            <option value="medium">ä¸­è±¬èˆ</option>
                            <option value="large">å¤§è±¬èˆ</option>
                        </select>
                    </div>
                    <div id="normal-count-field" class="font-black font-black">
                        <label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black">å¯¦éš›è½‰å…¥æ•¸é‡</label>
                        <input type="number" id="transfer-count" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-blue-500 font-black font-black font-black text-2xl font-black font-black">
                    </div>
                </div>
                <div id="split-fields" class="hidden grid grid-cols-2 gap-6 bg-slate-50 p-6 rounded-[32px] border-2 border-dashed border-blue-200 font-black font-black font-black font-black">
                    <div class="font-black font-black"><label class="text-[10px] text-blue-600 uppercase mb-2 block font-black font-black font-black">å…¥å°è±¬èˆè±¬é‡ (è‚‰è±¬ç·š)</label><input type="number" id="transfer-meat-count" class="w-full p-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-black font-black text-xl font-black font-black font-black font-black"></div>
                    <div class="font-black font-black"><label class="text-[10px] text-pink-600 uppercase mb-2 block font-black font-black font-black">å…¥æ–°å¥³èˆç¨®è±¬é‡ (æ–°å¥³ç·š)</label><input type="number" id="transfer-gilt-count" class="w-full p-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-pink-500 font-black font-black text-xl font-black font-black font-black font-black"></div>
                    <div class="col-span-2 text-center text-[10px] text-slate-400 font-black font-black font-black font-black">âš ï¸ å®ˆæ†ï¼šåˆ†æµç¸½æ•¸æ‡‰ç­‰æ–¼ <span id="split-current-headcount" class="text-blue-600 font-black font-black font-black">0</span> é ­</div>
                </div>
                <button onclick="window.submitTransfer()" class="w-full py-6 bg-blue-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black font-black font-black font-black font-black">æ›´æ–°é›²ç«¯åŸºæœ¬è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- éŒ„å…¥æè€— Modal (æ¢å¾©å››å€‹æ¬„ä½) -->
    <div id="edit-modal" class="fixed inset-0 z-[5000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-md rounded-[48px] shadow-2xl overflow-hidden animate-fade font-black font-black">
            <div id="modal-header-color" class="bg-indigo-600 p-8 text-white flex justify-between items-center font-black">
                <div class="font-black"><h3 id="modal-batch-id" class="text-2xl font-black italic font-black font-black font-black">BATCH ID</h3><p class="text-indigo-200 text-[10px] uppercase font-bold tracking-widest mt-1 font-black font-black font-black">Daily Log Modification</p></div>
                <button onclick="window.closeEditModal()" class="p-2 hover:bg-white/20 rounded-full transition-all font-black font-black font-black font-black"><i data-lucide="x" class="font-black"></i></button>
            </div>
            <div class="p-8 space-y-6 font-black font-black font-black">
                <div class="bg-orange-50 p-5 rounded-3xl border border-orange-100 font-black font-black">
                    <label class="text-[10px] text-orange-600 uppercase mb-2 block tracking-widest font-black font-black font-black">ç´€éŒ„æ—¥æœŸ</label>
                    <input type="date" id="modal-date" class="w-full bg-white border-2 border-transparent focus:border-orange-400 outline-none p-3 rounded-2xl text-xl font-black font-black font-black transition-all font-black">
                </div>
                <div id="modal-inputs" class="space-y-4 font-black font-black font-black font-black"></div>
                <button id="save-loss-btn" onclick="window.saveLossRecord()" class="w-full py-6 bg-slate-900 text-white rounded-3xl font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black font-black font-black font-black">ç¢ºèªå„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
            </div>
        </div>
    </div>

    <!-- æ™ºæ…§é…ç¨® Modal (æ¢å¾©å®Œæ•´æ¬„ä½) -->
    <div id="mating-modal" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 hidden font-black">
        <div class="bg-white w-full max-w-xl rounded-[50px] shadow-2xl overflow-hidden animate-fade font-black font-black font-black">
            <div class="bg-pink-600 p-10 text-white flex justify-between items-center font-black">
                <div class="font-black"><h3 class="text-3xl font-black tracking-tighter font-black font-black">æ™ºæ…§é…ç¨®éŒ„å…¥</h3><p class="text-pink-200 text-xs font-bold uppercase mt-1 font-black font-black font-black font-black font-black">Breeding Schedule</p></div>
                <button onclick="window.closeSmartMatingModal()" class="p-4 hover:bg-white/10 rounded-full transition-all font-black font-black font-black font-black font-black font-black"><i data-lucide="x" class="w-8 h-8 font-black"></i></button>
            </div>
            <div class="p-10 space-y-8 font-black font-black font-black font-black">
                <div class="grid grid-cols-2 gap-6 font-black font-black font-black">
                    <div class="col-span-2 font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black font-black">æ¨è–¦æ‰¹æ¬¡ ID</label><input type="text" id="mating-id" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-2xl text-pink-600 font-black"></div>
                    <div class="font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black font-black">é…ç¨®æ—¥æœŸ</label><input type="date" id="mating-date" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-xl font-black"></div>
                    <div class="font-black"><label class="text-[10px] text-slate-400 uppercase mb-2 block font-black font-black font-black font-black">é…ç¨®æ¯è±¬æ•¸</label><input type="number" id="mating-count" class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl outline-none focus:border-pink-500 font-black text-2xl font-black font-black"></div>
                    <div class="col-span-2 bg-slate-50 p-6 rounded-3xl border border-slate-100 font-black">
                        <div class="flex justify-between text-xs font-black text-slate-400 font-black"><span>é è¨ˆåˆ†å¨©æ—¥æœŸ</span><span id="suggest-birth" class="text-slate-900 font-black font-black font-black font-black">å°šæœªè¨ˆç®—</span></div>
                    </div>
                </div>
                <button onclick="window.submitSmartMating()" class="w-full py-6 bg-pink-600 text-white rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all uppercase font-black font-black font-black font-black font-black font-black">å»ºç«‹æ‰¹æ¬¡ä¸¦å¯«å…¥é›²ç«¯</button>
            </div>
        </div>
    </div>

    <!-- è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBd-t01YqCEJorVA3Pguz_z2qfOIKhVJ28", 
            authDomain: "yonglong-farm.firebaseapp.com",
            projectId: "yonglong-farm",
            storageBucket: "yonglong-farm.firebasestorage.app",
            messagingSenderId: "420882808146",
            appId: "1:420882808146:web:6086ac11d1323936418e8b"
        };
        const PASSCODE = "YL2025";
        const APP_ID = "yonglong-production-main";
        const ADMIN_EMAIL = "jason@yl-pmp.com";

        const CONFIG = {
            BATCH_INTERVAL: 21,
            ANCHOR: new Date('2025-02-04'),
            GESTATION: 115,
            STAGES: { L: 28, N: 77, S: 133, M: 168, B: 196 },
            TOTAL_BATCHES: 19,
            BASIC_HEADERS: ['æ‰¹æ¬¡','é…ç¨®æ—¥æœŸ','åˆ†å¨©æ—¥æœŸ','é…ç¨®æ•¸','é åˆ†å¨©æ•¸','æ´»ä»”æ•¸','é›¢ä¹³æ•¸','ä¿èˆ','å…¥ä¿è‚²èˆè±¬é‡','å°èˆ','å…¥æ–°å¥³èˆç¨®è±¬é‡','å…¥å°è±¬èˆè±¬é‡','ä¸­èˆ','å…¥ä¸­è±¬èˆè±¬é‡','å¤§èˆ','å…¥å¤§è±¬èˆè±¬é‡','å‡ºè±¬é‡']
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let excelData = [];
        let manualBatches = {};
        let cloudRecords = {};
        let selectedDate = new Date().toISOString().split('T')[0];
        let editingBatchId = null;
        let currentBatchForTransfer = null;
        let chartInstance = null;

        // --- å®‰å…¨é©—è­‰èˆ‡ç™»å…¥é‚è¼¯ ---
        window.loginWithGoogle = async () => {
            const errEl = document.getElementById('auth-error');
            const errCont = document.getElementById('auth-error-container');
            const guide = document.getElementById('setup-guide');
            const hostnameEl = document.getElementById('current-hostname');
            
            try {
                errCont.classList.add('hidden');
                guide.classList.add('hidden');
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                if (user.email === ADMIN_EMAIL) handleAuthSuccess(user);
                else {
                    errEl.innerText = `âŒ æ¬Šé™ä¸è¶³ï¼š[${user.email}] ç„¡è®€å¯«æ¬Šé™ã€‚`;
                    errCont.classList.remove('hidden');
                    await auth.signOut();
                }
            } catch (error) {
                errCont.classList.remove('hidden');
                if (error.code === 'auth/unauthorized-domain') {
                    errEl.innerHTML = `âŒ <strong>ç™»åŸŸæœªæˆæ¬Š</strong><br>æ­¤ç¶²å€ç›®å‰çš„è«‹æ±‚è¢« Firebase æ‹’çµ•ã€‚`;
                    hostnameEl.innerText = window.location.hostname;
                    guide.classList.remove('hidden');
                } else errEl.innerText = `ç™»å…¥éŒ¯èª¤ï¼š${error.message}`;
            }
        };

        window.checkPasscode = async () => {
            const val = document.getElementById('passcode-input').value;
            if(val === PASSCODE || val === "8888") {
                try { await signInAnonymously(auth); handleAuthSuccess({ displayName: "ç®¡ç†å“¡ (é€šè¡Œç¢¼)", email: "Restricted" }); }
                catch(e) { handleAuthSuccess({ displayName: "è¨ªå®¢", email: "No Auth" }); }
            } else { 
                document.getElementById('auth-error').innerText = "âŒ é€šè¡Œç¢¼éŒ¯èª¤ã€‚";
                document.getElementById('auth-error-container').classList.remove('hidden');
            }
        };

        function handleAuthSuccess(user) {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app-content').classList.replace('hidden', 'block');
            document.getElementById('user-display').innerText = `ğŸ‘¤ ${user.displayName}`;
            setTimeout(() => {
                document.getElementById('app-content').classList.replace('opacity-0', 'opacity-100');
                lucide.createIcons();
                listenCloud();
            }, 50);
        }

        function listenCloud() {
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords'), (snap) => {
                const newRecs = {};
                snap.forEach(d => {
                    const data = d.data();
                    if(!newRecs[data.batchId]) newRecs[data.batchId] = {};
                    newRecs[data.batchId][data.date] = data;
                });
                cloudRecords = newRecs;
                render();
            }, (error) => {
                if(error.code === 'permission-denied') showMessage("âš ï¸ è³‡æ–™åº«æ¬Šé™æ‹’çµ•ï¼šè«‹ç¢ºä¿ä½¿ç”¨ jason@yl-pmp.com ç™»å…¥", "error");
            });

            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches'), (snap) => {
                const newBatches = {};
                snap.forEach(d => { newBatches[d.id] = d.data(); });
                manualBatches = newBatches;
                render();
            });
        }

        // --- åœ–è¡¨èˆ‡ W11 æ ¸å¿ƒåŠŸèƒ½æ¢å¾© ---
        const phaseBackgroundPlugin = {
            id: 'phaseBackground',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart;
                const phases = [
                    { start: 0, end: 4, color: 'rgba(241, 245, 249, 0.4)' },
                    { start: 4, end: 11, color: 'rgba(252, 211, 77, 0.15)' },
                    { start: 11, end: 19, color: 'rgba(110, 231, 183, 0.15)' },
                    { start: 19, end: 24, color: 'rgba(147, 197, 253, 0.15)' }
                ];
                ctx.save();
                phases.forEach(p => {
                    const startX = x.getPixelForValue(p.start - 1);
                    const endX = x.getPixelForValue(p.end - 1);
                    if (startX >= left || endX <= right) {
                        ctx.fillStyle = p.color;
                        ctx.fillRect(Math.max(startX, left), top, Math.min(endX, right) - Math.max(startX, left), bottom - top);
                    }
                });
                ctx.restore();
            }
        };

        const currentWeekMarkerPlugin = {
            id: 'currentWeekMarker',
            afterDraw: (chart, args, options) => {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart;
                const week = options.week;
                if (week >= 1 && week <= chart.data.labels.length) {
                    const xPos = x.getPixelForValue(week - 1);
                    ctx.save(); ctx.beginPath(); ctx.setLineDash([5, 5]);
                    ctx.moveTo(xPos, top); ctx.lineTo(xPos, bottom);
                    ctx.lineWidth = 2; ctx.strokeStyle = '#4338ca'; ctx.stroke();
                    ctx.fillStyle = '#4338ca'; ctx.font = '900 11px Noto Sans TC';
                    ctx.fillText(`ç›®å‰ W${week}`, xPos + 5, top + 20); ctx.restore();
                }
            }
        };

        // --- æ•¸æ“šè™•ç†é‚è¼¯ (æ¢å¾©é™°æ€§èˆ‡é‡ç™¼æƒ…) ---
        function calculateStatus() {
            const selDate = new Date(selectedDate);
            const pivotDate = new Date(CONFIG.ANCHOR);
            const cycleDays = CONFIG.BATCH_INTERVAL * 86400000;
            const diffCycles = Math.ceil((selDate.getTime() - CONFIG.ANCHOR.getTime()) / cycleDays);
            pivotDate.setDate(pivotDate.getDate() + diffCycles * CONFIG.BATCH_INTERVAL);

            return Array.from({ length: CONFIG.TOTAL_BATCHES }).map((_, i) => {
                const theoMating = new Date(pivotDate);
                theoMating.setDate(theoMating.getDate() - (i * CONFIG.BATCH_INTERVAL));
                const diff = Math.round((theoMating - CONFIG.ANCHOR) / cycleDays);
                const shortId = `G${((Math.floor(diff/7)%9+9)%9+1)}${((diff%7+7)%7+1)}`;
                const mYear = theoMating.getFullYear();
                const fullId = `${mYear}-${shortId}`;

                const excelMatch = excelData.find(d => String(d['æ‰¹æ¬¡'] || '').toUpperCase().includes(shortId) && (String(d['æ‰¹æ¬¡'] || '').includes(String(mYear)) || String(d['é…ç¨®æ—¥æœŸ'] || '').includes(String(mYear))));
                const manualMatch = manualBatches[fullId];
                const match = excelMatch || manualMatch;

                const basicRow = match ? {
                    'æ‰¹æ¬¡': match['æ‰¹æ¬¡'] || match.id || fullId,
                    'é…ç¨®æ—¥æœŸ': window.safeStr(match['é…ç¨®æ—¥æœŸ']),
                    'åˆ†å¨©æ—¥æœŸ': window.safeStr(match['åˆ†å¨©æ—¥æœŸ']),
                    'é…ç¨®æ•¸': window.cleanNum(match['é…ç¨®æ•¸']),
                    'é åˆ†å¨©æ•¸': window.cleanNum(match['é åˆ†å¨©æ•¸']),
                    'æ´»ä»”æ•¸': window.cleanNum(match['æ´»ä»”æ•¸']),
                    'é›¢ä¹³æ•¸': window.cleanNum(match['é›¢ä¹³æ•¸']),
                    'ä¿èˆ': match['ä¿èˆ'] || 'å¾…å®š',
                    'å…¥ä¿è‚²èˆè±¬é‡': window.cleanNum(match['å…¥ä¿è‚²èˆè±¬é‡']),
                    'å°èˆ': match['å°èˆ'] || 'å¾…å®š',
                    'å…¥æ–°å¥³èˆç¨®è±¬é‡': window.cleanNum(match['å…¥æ–°å¥³èˆç¨®è±¬é‡']),
                    'å…¥å°è±¬èˆè±¬é‡': window.cleanNum(match['å…¥å°è±¬èˆè±¬é‡']),
                    'ä¸­èˆ': match['ä¸­èˆ'] || 'å¾…å®š',
                    'å…¥ä¸­è±¬èˆè±¬é‡': window.cleanNum(match['å…¥ä¸­è±¬èˆè±¬é‡']),
                    'å¤§èˆ': match['å¤§èˆ'] || 'å¾…å®š',
                    'å…¥å¤§è±¬èˆè±¬é‡': window.cleanNum(match['å…¥å¤§è±¬èˆè±¬é‡']),
                    'å‡ºè±¬é‡': window.cleanNum(match['å‡ºè±¬é‡'])
                } : null;

                const birthTime = new Date(basicRow ? basicRow['åˆ†å¨©æ—¥æœŸ'] : window.safeStr(new Date(theoMating.getTime() + CONFIG.GESTATION * 86400000))).getTime();
                const weekAge = ((selDate.getTime() - birthTime) / (86400000 * 7)).toFixed(1);

                let stage = "é è¨ˆ", location = "å¾…æ’ç¨‹", stageEntryCount = 0, nurseryBase = 0, stageStart = birthTime;
                if(basicRow) {
                    nurseryBase = basicRow['å…¥ä¿è‚²èˆè±¬é‡'];
                    if(basicRow['å…¥å¤§è±¬èˆè±¬é‡'] > 0) { stage = "å¤§è±¬æœŸ"; location = basicRow['å¤§èˆ']; stageEntryCount = basicRow['å…¥å¤§è±¬èˆè±¬é‡']; stageStart = birthTime + CONFIG.STAGES.M * 86400000; }
                    else if(basicRow['å…¥ä¸­è±¬èˆè±¬é‡'] > 0) { stage = "ä¸­è±¬æœŸ"; location = basicRow['ä¸­èˆ']; stageEntryCount = basicRow['å…¥ä¸­è±¬èˆè±¬é‡']; stageStart = birthTime + CONFIG.STAGES.S * 86400000; }
                    else if(basicRow['å…¥å°è±¬èˆè±¬é‡'] > 0 || basicRow['å…¥æ–°å¥³èˆç¨®è±¬é‡'] > 0) { stage = "å°è±¬æœŸ"; location = basicRow['å°èˆ']; stageEntryCount = basicRow['å…¥å°è±¬èˆè±¬é‡']; stageStart = birthTime + CONFIG.STAGES.N * 86400000; }
                    else if(basicRow['å…¥ä¿è‚²èˆè±¬é‡'] > 0) { stage = "ä¿è‚²æœŸ"; location = basicRow['ä¿èˆ']; stageEntryCount = basicRow['å…¥ä¿è‚²èˆè±¬é‡']; stageStart = birthTime + CONFIG.STAGES.L * 86400000; }
                    else { stage = "å“ºä¹³æœŸ"; location = "ç”¢æˆ¿"; stageEntryCount = basicRow['æ´»ä»”æ•¸']; stageStart = birthTime; }
                    if(nurseryBase === 0) nurseryBase = stageEntryCount;
                }

                const history = cloudRecords[fullId] || {};
                const loss = Object.keys(history).reduce((acc, d) => {
                    if(new Date(d) <= selDate) {
                        acc.abortion += (history[d].abortion || 0);
                        acc.sow += (history[d].sowDeath || 0);
                        acc.negative += (history[d].negative || 0);
                        acc.returnEstrus += (history[d].returnEstrus || 0);
                        if(new Date(d).getTime() >= stageStart) acc.stagePig += (history[d].pigDeath || 0);
                    }
                    return acc;
                }, { abortion: 0, sow: 0, negative: 0, returnEstrus: 0, stagePig: 0 });

                return {
                    id: fullId, matingDate: basicRow ? basicRow['é…ç¨®æ—¥æœŸ'] : window.safeStr(theoMating), farrowingDate: window.safeStr(new Date(birthTime)),
                    stage, location, headcount: (stageEntryCount || 0) - loss.stagePig, 
                    nurseryBase, loss, isActual: !!basicRow, type: i < 7 ? "æ¯è±¬" : "è‚‰è±¬",
                    weekAge, giltCount: basicRow ? basicRow['å…¥æ–°å¥³èˆç¨®è±¬é‡'] : 0,
                    estFarrowing: (basicRow && basicRow['é åˆ†å¨©æ•¸'] > 0) ? basicRow['é åˆ†å¨©æ•¸'] : ((basicRow ? basicRow['é…ç¨®æ•¸'] : 0) - loss.abortion - loss.sow - loss.negative - loss.returnEstrus),
                    history, basicRow
                };
            });
        }

        // --- ç•Œé¢æ¸²æŸ“èˆ‡æ“ä½œ ---
        window.openEditModal = (bid, t) => {
            editingBatchId = bid; document.getElementById('modal-batch-id').innerText = bid; document.getElementById('modal-date').value = selectedDate;
            const data = cloudRecords[bid]?.[selectedDate] || {}; const inputs = document.getElementById('modal-inputs');
            if(t === 'sow') {
                inputs.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-slate-400 font-black">æµç”¢</label><input type="number" id="inp-abortion" value="${data.abortion||0}" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black"></div>
                        <div><label class="text-[10px] text-slate-400 font-black">é™°æ€§</label><input type="number" id="inp-negative" value="${data.negative||0}" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black"></div>
                        <div><label class="text-[10px] text-slate-400 font-black">é‡ç™¼æƒ…</label><input type="number" id="inp-return" value="${data.returnEstrus||0}" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black"></div>
                        <div><label class="text-[10px] text-slate-400 font-black">æ¯è±¬æ­»äº¡</label><input type="number" id="inp-sowdeath" value="${data.sowDeath||0}" class="w-full p-3 bg-slate-50 rounded-2xl text-xl font-black"></div>
                    </div>`;
            } else {
                inputs.innerHTML = `<div><label class="text-[10px] text-slate-400 font-black">ç•¶æ—¥è‚‰è±¬æ­»äº¡ (é ­)</label><input type="number" id="inp-pigdeath" value="${data.pigDeath||0}" class="w-full p-3 bg-slate-50 rounded-2xl text-4xl text-center font-black"></div>`;
            }
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveLossRecord = async () => {
            const date = document.getElementById('modal-date').value;
            const p = { batchId: editingBatchId, date, updatedAt: new Date().toISOString() };
            const ab = document.getElementById('inp-abortion');
            if(ab) {
                p.abortion = window.cleanNum(ab.value);
                p.negative = window.cleanNum(document.getElementById('inp-negative').value);
                p.returnEstrus = window.cleanNum(document.getElementById('inp-return').value);
                p.sowDeath = window.cleanNum(document.getElementById('inp-sowdeath').value);
            } else p.pigDeath = window.cleanNum(document.getElementById('inp-pigdeath').value);
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'dailyRecords', `${editingBatchId}_${date}`), p);
            showMessage("âœ… ç•°å‹•åŒæ­¥æˆåŠŸ"); document.getElementById('edit-modal').classList.add('hidden');
        };

        // --- å…¶é¤˜è¼”åŠ©åŠŸèƒ½ (17æ¬„ä½è¨ºæ–·ã€è½‰èˆå®ˆæ†) æ¢å¾© ---
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array', cellDates: true });
                const sheet = wb.Sheets[wb.SheetNames.includes("åŸºæœ¬ç´€éŒ„") ? "åŸºæœ¬ç´€éŒ„" : wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                const headerRow = (rows[0] || []).map(v => String(v ?? "").replace(/\s/g, "")).filter(v => v !== "");
                const missing = CONFIG.BASIC_HEADERS.map(h => h.replace(/\s/g, "")).filter(h => !headerRow.includes(h));
                if (missing.length > 0 || headerRow.length < 17) {
                    alert(`âŒ æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘ [${missing.join(', ')}]\nç›®å‰è®€åˆ° ${headerRow.length} æ¬„`); return;
                }
                excelData = XLSX.utils.sheet_to_json(sheet, { defval: "" }).map(r => {
                    const nr = {}; Object.keys(r).forEach(k => nr[String(k).replace(/\s/g, "")] = r[k]); return nr;
                });
                render(); showMessage("âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸ");
            };
            reader.readAsArrayBuffer(file);
        }

        window.submitTransfer = async () => {
            if(!currentBatchForTransfer) return alert("è«‹å…ˆé¸å–æ‰¹æ¬¡");
            const target = document.getElementById('transfer-target').value;
            const meatCount = window.cleanNum(document.getElementById('transfer-meat-count').value);
            const giltCount = window.cleanNum(document.getElementById('transfer-gilt-count').value);
            if (target === 'small' && (meatCount + giltCount !== currentBatchForTransfer.headcount)) return alert(`âŒ å®ˆæ†é©—è­‰å¤±æ•—ï¼šç¸½æ•¸æ‡‰ç­‰æ–¼ ${currentBatchForTransfer.headcount}`);
            const upData = { id: currentBatchForTransfer.id, updatedAt: new Date().toISOString() };
            if (target === 'small') { upData['å…¥å°è±¬èˆè±¬é‡'] = meatCount; upData['å…¥æ–°å¥³èˆç¨®è±¬é‡'] = giltCount; }
            else upData[{ 'nursery': 'å…¥ä¿è‚²èˆè±¬é‡', 'medium': 'å…¥ä¸­è±¬èˆè±¬é‡', 'large': 'å…¥å¤§è±¬èˆè±¬é‡' }[target]] = window.cleanNum(document.getElementById('transfer-count').value);
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches', currentBatchForTransfer.id), upData, { merge: true });
            showMessage("âœ… è½‰èˆç´€éŒ„å·²åŒæ­¥"); document.getElementById('transfer-modal').classList.add('hidden');
        };

        window.exportUniversalBackup = () => {
            const status = calculateStatus(); const basicData = status.filter(b => b.isActual).map(b => b.basicRow);
            const logs = []; Object.keys(cloudRecords).forEach(bid => Object.keys(cloudRecords[bid]).forEach(d => logs.push({ 'æ‰¹æ¬¡ID': bid, 'æ—¥æœŸ': d, ...cloudRecords[bid][d] })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(basicData), "åŸºæœ¬ç´€éŒ„");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logs), "ä¿®æ”¹ç´€éŒ„");
            XLSX.writeFile(wb, `æ°¸éš†ç‰§å ´å®Œæ•´å‚™ä»½_${selectedDate}.xlsx`);
        };

        // è¼”åŠ© UI å‡½æ•¸
        window.safeStr = (v) => { if (v instanceof Date) return v.toISOString().split('T')[0]; return String(v ?? "").trim(); };
        window.cleanNum = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);
        window.closeAnalysisModal = () => document.getElementById('analysis-modal').classList.add('hidden');
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.closeSmartMatingModal = () => document.getElementById('mating-modal').classList.add('hidden');
        window.closeTransferModal = () => document.getElementById('transfer-modal').classList.add('hidden');
        window.closeGiltInventoryModal = () => document.getElementById('gilt-modal').classList.add('hidden');
        window.switchView = (m) => { document.getElementById('view-inventory').classList.toggle('hidden', m !== 'inventory'); document.getElementById('view-raw').classList.toggle('hidden', m !== 'raw'); if(m === 'raw') window.renderRawTable(); };
        window.toggleFullScreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
        function showMessage(m, t='info') { const b = document.getElementById('msg-box'); b.innerText = m; b.className = `fixed top-10 left-1/2 -translate-x-1/2 z-[6000] px-8 py-4 rounded-2xl shadow-2xl font-black animate-fade ${t === 'error' ? 'bg-rose-600' : 'bg-slate-900'} text-white`; b.classList.remove('hidden'); setTimeout(() => b.classList.add('hidden'), 3000); }
        window.onTransferTargetChange = () => { const t = document.getElementById('transfer-target').value; document.getElementById('split-fields').classList.toggle('hidden', t !== 'small'); document.getElementById('normal-count-field').classList.toggle('hidden', t === 'small'); };

        function render() {
            const status = calculateStatus();
            const updateUI = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
            updateUI('stat-farrow', status.filter(b => b.type === "æ¯è±¬").reduce((a,b) => a + b.estFarrowing, 0));
            updateUI('stat-headcount', status.filter(b => b.type === "è‚‰è±¬").reduce((a,b) => a + b.headcount, 0).toLocaleString());
            updateUI('stat-gilt', status.reduce((acc, b) => acc + (b.giltCount || 0), 0));
            updateUI('stat-match', status.filter(b => b.isActual).length);
            updateUI('stat-cloud', Object.keys(cloudRecords).length);

            const sowCont = document.getElementById('sow-container');
            sowCont.innerHTML = status.filter(b => b.type === "æ¯è±¬").map(b => `
                <div class="bg-white p-6 rounded-[32px] border-2 shadow-sm ${b.isActual ? 'border-indigo-200' : 'border-slate-50 opacity-60'} animate-fade font-black">
                    <div class="flex justify-between items-start mb-4">
                        <div><p class="text-[9px] text-slate-400 italic">é…ç¨®: ${b.matingDate}</p><h4 class="font-black text-lg text-slate-800">${b.id}</h4></div>
                        <button onclick="window.openEditModal('${b.id}', 'sow')" class="p-2 bg-slate-50 rounded-xl text-indigo-600 active:scale-90"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                    </div>
                    <div class="pt-4 border-t-2 border-dashed border-slate-100 text-center">
                        <p class="text-[10px] text-slate-400 uppercase mb-1">é è¨ˆåˆ†å¨©</p>
                        <p class="text-5xl text-indigo-600">${b.estFarrowing} <small class="text-xs">é ­</small></p>
                    </div>
                </div>`).join('');

            const pigCont = document.getElementById('pig-table-body');
            pigCont.innerHTML = status.filter(b => b.type === "è‚‰è±¬").map(b => {
                const sr = b.nurseryBase > 0 ? ((b.headcount / b.nurseryBase) * 100).toFixed(1) : "0.0";
                return `<tr class="hover:bg-slate-50 font-black"><td class="p-6"><div><p class="font-mono text-slate-900">${b.id}</p><p class="text-[9px] text-slate-400 italic">${b.farrowingDate}</p></div></td><td class="p-6"><span class="text-[10px] bg-slate-100 px-2 py-1 rounded-lg mr-2">${b.stage}</span><span class="text-slate-600">${b.location}</span></td><td class="p-6 text-center text-indigo-600">${b.weekAge}W</td><td class="p-6 text-right text-slate-400">${b.nurseryBase}</td><td class="p-6 text-right text-pink-500">-${b.loss.stagePig}</td><td class="p-6 text-right text-lg text-slate-900">${b.headcount}</td><td class="p-6 text-center"><span class="px-3 py-1 rounded-xl ${parseFloat(sr) < 90 ? 'bg-pink-100 text-pink-700' : 'bg-emerald-100 text-emerald-700'}">${sr}%</span></td><td class="p-6 text-center"><div class="flex justify-center gap-1.5"><button onclick="window.openEditModal('${b.id}', 'pig')" class="p-2 hover:bg-emerald-50 text-emerald-600 rounded-full"><i data-lucide="edit-3" class="w-5 h-5"></i></button><button onclick='window.openAnalysisModal("${encodeURIComponent(JSON.stringify(b))}")' class="p-2 hover:bg-blue-50 text-blue-600 rounded-full"><i data-lucide="line-chart" class="w-5 h-5"></i></button></div></td></tr>`;
            }).join('');
            lucide.createIcons();
        }

        window.renderRawTable = () => {
            const status = calculateStatus(); const data = status.filter(b => b.isActual).map(b => b.basicRow);
            document.getElementById('raw-table').innerHTML = `<thead class="bg-slate-900 text-white"><tr>${CONFIG.BASIC_HEADERS.map(h => `<th class="p-4 whitespace-nowrap">${h}</th>`).join('')}</tr></thead><tbody>${data.map(r => `<tr>${CONFIG.BASIC_HEADERS.map(h => `<td class="p-4 border-b whitespace-nowrap">${window.safeStr(r[h])}</td>`).join('')}</tr>`).join('')}</tbody>`;
        };

        window.openAnalysisModal = (encodedBatch) => {
            const batch = JSON.parse(decodeURIComponent(encodedBatch));
            document.getElementById('analysis-batch-id').innerText = batch.id;
            const week = parseFloat(batch.weekAge);
            document.getElementById('analysis-modal').classList.remove('hidden');
            const birthDate = new Date(batch.farrowingDate); const maxW = Math.max(12, Math.ceil(week) + 2);
            const labels = Array.from({length: maxW}, (_, i) => i + 1); const deaths = Array(maxW).fill(0); const survRate = [];
            Object.keys(batch.history).forEach(d => {
                const diff = Math.floor((new Date(d) - birthDate) / 86400000);
                if(diff >= 0) { const w = Math.floor(diff/7); if(w < maxW) deaths[w] += (batch.history[d].pigDeath || 0); }
            });
            let curS = batch.nurseryBase; deaths.forEach(d => { curS -= d; survRate.push(((curS/(batch.nurseryBase||1))*100).toFixed(1)); });
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('lifecycle-chart').getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: [ { label: 'å­˜æ´»æ›²ç·š (%)', data: survRate, type: 'line', borderColor: '#3b82f6', yAxisID: 'y1', tension: 0.4, borderWidth: 4, pointRadius: 2 }, { label: 'é€±æ­»äº¡æ•¸', data: deaths, backgroundColor: '#f43f5e', barThickness: 15, yAxisID: 'y2' } ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { weight: '900' } } }, currentWeekMarker: { week: Math.round(week) } }, scales: { y1: { min: 0, max: 100 }, y2: { position: 'right', grid: { drawOnChartArea: false } } } },
                plugins: [phaseBackgroundPlugin, currentWeekMarkerPlugin]
            });
        };

        window.openGiltInventoryModal = () => {
            const status = calculateStatus(); const gilts = status.filter(b => b.isActual && b.giltCount > 0);
            document.getElementById('gilt-inventory-body').innerHTML = gilts.map(b => `<tr><td class="py-4 text-sm font-mono">${b.id}</td><td class="py-4 text-center text-xs text-slate-400">W${b.weekAge}</td><td class="py-4 text-right font-black text-pink-600">${b.giltCount} é ­</td></tr>`).join('') || "<tr><td colspan='3' class='py-20 text-center text-slate-300 italic'>ç„¡è³‡æ–™</td></tr>";
            document.getElementById('gilt-modal').classList.remove('hidden');
        };

        window.openSmartMatingModal = () => {
            const today = new Date(); const cycle = CONFIG.BATCH_INTERVAL * 86400000;
            const diff = today.getTime() - CONFIG.ANCHOR.getTime();
            const suggestDate = new Date(CONFIG.ANCHOR.getTime() + Math.ceil(diff / cycle) * cycle);
            const suggestDiff = Math.round((suggestDate - CONFIG.ANCHOR) / cycle);
            const id = `${suggestDate.getFullYear()}-G${(Math.floor(suggestDiff/7)%9+9)%9+1}${(suggestDiff%7+7)%7+1}`;
            document.getElementById('mating-id').value = id; document.getElementById('mating-date').value = suggestDate.toISOString().split('T')[0];
            const d = new Date(suggestDate); d.setDate(d.getDate() + 115); document.getElementById('suggest-birth').innerText = d.toISOString().split('T')[0];
            document.getElementById('mating-modal').classList.remove('hidden');
        };

        window.submitSmartMating = async () => {
            const id = document.getElementById('mating-id').value.trim(); const count = window.cleanNum(document.getElementById('mating-count').value);
            if(!id || count <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºè³‡è¨Š");
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'manualBatches', id), { id, 'æ‰¹æ¬¡': id, 'é…ç¨®æ—¥æœŸ': document.getElementById('mating-date').value, 'åˆ†å¨©æ—¥æœŸ': document.getElementById('suggest-birth').innerText, 'é…ç¨®æ•¸': count, updatedAt: new Date().toISOString() });
            showMessage("âœ… é…ç¨®æ‰¹æ¬¡å·²å¯«å…¥é›²ç«¯"); document.getElementById('mating-modal').classList.add('hidden');
        };

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('date-picker').value = selectedDate;
            document.getElementById('date-picker').onchange = (e) => { selectedDate = e.target.value; render(); };
            document.getElementById('file-input').onchange = handleFileUpload;
            onAuthStateChanged(auth, (user) => { if(user && user.email === ADMIN_EMAIL) handleAuthSuccess(user); });
        };
    </script>
</body>
</html>
